G.GeoGridUtil={calcIndex:function(b,c,a){if(!(180<c||-180>c||90<a||-90>a)){var d=Math.floor,e=Math.pow(2,b);b=180/e;e=2/e;a=Math.sin(a/G.MathUtil.DEGREE_PER_RADIAN);c=d(c/b);d=d(a/e);return[c,d]}},getGrid:function(b,c,a){var d=Math.asin;b=Math.pow(2,b);var e=180/b,g=2/b;b=(c+1)*e;var f=(a+1)*g;c*=e;a=d(a*g)*G.MathUtil.DEGREE_PER_RADIAN;d=d(f)*G.MathUtil.DEGREE_PER_RADIAN;f=[];f.push([c,a]);f.push([c,d]);f.push([b,d]);f.push([b,a]);return[f]}};
G.Layer.GeoGrid=G.Layer.Graphic.extend({options:{gridOutline:!0,gridOutlineColor:"#0f0",gridOutlineWidth:2,gridOutlineOpacity:1,gridFill:!0,gridFillColor:"#000",gridFillOpacity:0.3},init:function(b,c,a){this.options=G.Util.merge({},this.options,a);G.Layer.Graphic.prototype.init.call(this,a);this._level=b;this._projClass=c;this._grids={}},getLevel:function(){return this._level},getGridByIndex:function(b,c){return this._grids[b+","+c]},getGridByLL:function(b,c){var a=G.GeoGridUtil.calcIndex(this._level,
b,c);return this.getGridByIndex(a[0],a[1])},_update:function(){var b=this._map;if(b._isLoaded()){var c=this.options,a=b.getCenter(),d=b.getResolution(),e=b.getDrawSize(),g=1+2*b.options.canvasExpandFactor,f=e[0]*g,e=e[1]*g,a=G.ExtentUtil.intersect([a[0]-f*d/2,a[1]-e*d/2,a[0]+f*d/2,a[1]+e*d/2],b.options.maxExtent);(b=this._projClass)?(f=G.ProjUtil.projectPoint([a[0],a[1]],b.unproject),a=G.ProjUtil.projectPoint([a[2],a[3]],b.unproject)):(f=[a[0],a[1]],a=[a[2],a[3]]);var g=Math.max,h=Math.min,d=h(180,
g(-180,f[0])),e=h(90,g(-90,f[1])),f=h(180,g(-180,a[0])),g=h(90,g(-90,a[1])),a=this._level,d=G.GeoGridUtil.calcIndex(a,d,e),f=G.GeoGridUtil.calcIndex(a,f,g),k,e={};for(k in this._grids)e[k]=!0;var m,n,l,g=d[0];for(m=f[0];g<=m;g++)for(h=d[1],n=f[1];h<=n;h++)k=g+","+h,e[k]=!1,this._grids[k]||(l=G.GeoGridUtil.getGrid(a,g,h),b&&(l=G.ProjUtil.projectPolygon(l,b.project)),l=new G.Graphic.Polygon(l,{idx:g,idy:h},{outline:c.gridOutline,outlineColor:c.gridOutlineColor,outlineWidth:c.gridOutlineWidth,outlineOpacity:c.gridOutlineOpacity,
fill:c.gridFill,fillColor:c.gridFillColor,fillOpacity:c.gridFillOpacity}),this._grids[k]=l,l.addTo(this));for(k in e)e[k]&&((l=this._grids[k])&&l.remove(),this._grids[k]=void 0);this._draw()}}});
