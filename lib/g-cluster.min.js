G.Graphic.Cluster=G.Graphic.Group.extend({options:{clickable:!0},init:function(a,c,b,e){var f=new G.Graphic.Point(null,null,{shape:"circle",size:[32],fillColor:"#000",fillOpacity:1,outline:!0,outlineColor:"#000",outlineWidth:10,outlineOpacity:0.6}),g=new G.Graphic.Point(null,null,{shape:"text",size:[16],fillColor:"#fff",text:0});this.options=G.Util.merge({},this.options,e);G.Graphic.Group.prototype.init.call(this,[f,g],null,e);this._group=a;this._zoom=c;this._tree=b;this.bbox=this.geom=null;this._childCount=
0;this._childClusters=[];this._childPoints=[]},count:function(){var a=this._childPoints.length,c,b;for(c in this._childClusters)b=this._childClusters[c],a+=b.count();return a},getNextZoom:function(){var a=this._layer,c=this._zoom;if(!a||!a._showRelZoom)return c;for(var a=a._showRelZoom,b=this,c=c+1;c<=a;c++){if(1<b._childClusters.length+b._childPoints.length||0==b._childClusters.length)return c;b=b._childClusters[0]}return a},_ensureStyle:function(){var a=this._layer;if(a){var c=this._childCount,
b=this._graphics,e=b[0].options,b=b[1].options,a=a.options,f=a.breakValues.length,g=0;c<=a.breakValues[g]&&this._readLayerStyle(a,g,e,b);for(g=1;g<f;g++)c>a.breakValues[g-1]&&c<=a.breakValues[g]&&this._readLayerStyle(a,g,e,b);g=f;c>a.breakValues[g-1]&&this._readLayerStyle(a,g,e,b)}},_readLayerStyle:function(a,c,b,e){b.size=[a.breakShapeSizes[c]];b.fillColor=a.breakFillColors[c];b.fillOpacity=a.breakFillOpacities[c];b.outline=a.breakOutlines[c];b.outlineColor=a.breakOutlineColors[c];b.outlineOpacity=
a.breakOutlineOpacities[c];b.outlineWidth=a.breakOutlineWidths[c];e.size=[a.breakTextSizes[c]];e.fillColor=a.breakTextColors[c]},_updateByAdd:function(a,c){var b=0;if(a instanceof G.Graphic.Cluster){if(c||!this._inList(this._childClusters,a))b=a._childCount}else if(c||!this._inList(this._childPoints,a))b=1;var e=this._childCount,f=this._childCount=e+b,g=this._graphics,d,k;this.geom?a.geom&&(d=this.geom[0],k=this.geom[1],x=a.geom[0],y=a.geom[1],d=(d*e+x*b)/f,b=(k*e+y*b)/f,d=this.geom=[d,b],this.bbox=
[d[0],d[1],d[0],d[1]]):d=this.geom=a.geom;d&&(g[0].updateGeom(d,!0),g[1].updateGeom(d,!0));g[1].options.text=f},_addChild:function(a,c,b){var e=this._tree;e&&(this.geom&&void 0!==this.geom[0]&&void 0!==this.geom[1])&&e.remove([this.geom[0]-1,this.geom[1]-1,this.geom[0]+1,this.geom[1]+1],this);this._updateByAdd(a);e&&e.insert(this.bbox,this);c||(a._group=this,a instanceof G.Graphic.Cluster?this._childClusters.push(a):this._childPoints.push(a));this._group&&!b&&this._group._addChild(a,!0);this._ensureStyle()},
_updateByRemove:function(a,c){var b=0;if(a instanceof G.Graphic.Cluster){if(c||this._inList(this._childClusters,a))b=a._childCount}else if(c||this._inList(this._childPoints,a))b=1;var e=this._childCount,f=this._childCount=e-b,g=this._graphics,d,k;0==f?(this.bbox=this.geom=null,g[0].geom=null,g[0].bbox=null,g[1].geom=null,g[1].bbox=null):this.geom&&a.geom&&(d=this.geom[0],k=this.geom[1],x=a.geom[0],y=a.geom[1],d=(d*e-x*b)/f,b=(k*e-y*b)/f,b=this.geom=[d,b],this.bbox=[b[0],b[1],b[0],b[1]],g[0].updateGeom(b,
!0),g[1].updateGeom(b,!0));g[1].options.text=f},_removeChild:function(a,c,b){var e=this._tree;e&&(this.geom&&void 0!==this.geom[0]&&void 0!==this.geom[1])&&e.remove([this.geom[0]-1,this.geom[1]-1,this.geom[0]+1,this.geom[1]+1],this);this._updateByRemove(a,c);e&&e.insert(this.bbox,this);c||(a._group=null,a instanceof G.Graphic.Cluster?this._removeFromList(this._childClusters,a):this._removeFromList(this._childPoints,a));this._group&&!b&&this._group._removeChild(a,!0);this._ensureStyle()},_inList:function(a,
c){return a&&a.indexOf&&0<=a.indexOf(c)},_removeFromList:function(a,c){var b,e;for(b in a)if(e=a[b],e===c){a.splice(b,1);break}},_offClickable:function(){this.options.clickable=!1;var a=this._graphics,c,b;for(c in a)b=a[c],b.options.clickable=this.options.clickable},_onClickable:function(){this.options.clickable=this._layer.options.clusterClickable;var a=this._graphics,c,b;for(c in a)b=a[c],b.options.clickable=this.options.clickable}});
G.Layer.Cluster=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{radius:50,showRealRes:null,pointClickable:!1,clusterClickable:!1,breakValues:[5,10,20],breakShapeSizes:[24,32,40,48],breakFillColors:["#71e28c","#58d7dd","#efcd45","#ff936a"],breakFillOpacities:[1,1,1,1],breakOutlines:[!0,!0,!0,!0],breakOutlineColors:["#71e28c","#58d7dd","#efcd45","#ff936a"],breakOutlineOpacities:[0.6,0.6,0.6,0.6],breakOutlineWidths:[12,16,20,24],breakTextSizes:[16,18,20,24],breakTextColors:["#fff","#fff","#fff",
"#fff"]},init:function(a){this.options=G.Util.merge({},this.options,a);G.Layer.Graphic.prototype.init.call(this,a);this._showRelZoom=this._zoom=0;this._clusteredTrees=[];this._unclusteredTrees=[];this._spiderCluster=null},count:function(){var a=this._clusteredTrees[0],c=this._unclusteredTrees[0].count(),a=a.all(),b,e;for(b in a)e=a[b],c+=e.count();return c},addPoint:function(a,c){if(a instanceof G.Graphic.Point){a.addTo(this);var b=a._id,e=this.options,f={clickable:e.clickable},g=e.radius,e=e.zoomReses,
d=a.geom,k=this._clusteredTrees,l=this._unclusteredTrees,h,m,n;for(h=this._showRelZoom;0<=h;h--){m=e[h]*g;if(n=this._searchNearest(k[h],d,m)){n._addChild(a);break}if(m=this._searchNearest(l[h],d,m)){for(d=h;0<=d;d--)l[d].remove(m.bbox,m);(l=m._group)&&l._removeChild(m);l=new G.Graphic.Cluster(null,h,k[h],f);l.addTo(this);n=[l];for(d=h-1;0<=d;d--)if((h=this._searchNearest(k[d],m.geom,e[d]*g))&&(h._group||0==d)){n.push(h);break}else h=new G.Graphic.Cluster(null,d,k[d],f),h.addTo(this),n.push(h);for(d=
0;d<n.length-1;d++)n[d]._group||n[d+1]._addChild(n[d]);l._addChild(m);l._addChild(a);break}l[h].insert(a.bbox,a)}return b}},removePoint:function(a,c){var b=this._dataPoints[a];delete this._dataPoints[a];this._tree.remove(b.bbox,b);c&&this._draw();return this},clear:function(){var a=this._map;this._graphics={};this._tree.clear();delete this._hitGraphic;var c,b;c=0;for(b=this._clusteredTrees.length;c<b;c++)this._clusteredTrees[c].clear();c=0;for(b=this._unclusteredTrees.length;c<b;c++)this._unclusteredTrees[c].clear();
this._onClear();a&&a._requestRedraw();return this},diveIn:function(a){var c=this._map,b=a.geom;a=a.getNextZoom();a=this.options.zoomReses[a];var e=c._size;c.zoomTo(b,e[0]*a,e[1]*a);return this},_onAdded:function(){var a=this._map,c=this.options;this._container||this._initContainer();this.options.zoomReses=a._zoomReses;var b=c.zoomReses,e=b.length-1,c=c.showRealRes||b[e],f,g;for(f=0;f<e;f++){g=b[f];if(g<c)break;this._clusteredTrees[f]=new G.RTree;this._unclusteredTrees[f]=new G.RTree;this._showRelZoom=
f}this.addListener("graphicClicked",this._onGraphicClicked);this.addListener("graphicOver",this._onGraphicOver);this.addListener("graphicOut",this._onGraphicOut);a.addListener("click",this._onClick,this);a.addListener("mousemove",this._onMouseMove,this)},_onRemoved:function(){var a=this._map;this._container&&this._destroyContainer();this.removeListener("graphicClicked",this._onGraphicClicked);this.removeListener("graphicOver",this._onGraphicOver);this.removeListener("graphicOut",this._onGraphicOut);
a.removeListener("click",this._onClick,this);a.removeListener("mousemove",this._onMouseMove,this)},_searchNearest:function(a,c,b){var e=c[0],f=c[1];a=a.search([e-b,f-b,e+b,f+b]);return this._getNearest(a,c,b)},_getNearest:function(a,c,b){if(a){b*=b;var e,f,g,d;for(f in a)g=a[f],d=g.geom,d=this._sqrDis(d,c),d<b&&(e=g,b=d);return e}},_sqrDis:function(a,c){var b=a[0]-c[0],e=a[1]-c[1];return b*b+e*e},_onGraphicClicked:function(a){(a=a.graphic._parentGraphic)&&a instanceof G.Graphic.Cluster&&this.fireEvent("clusterClicked",
{cluster:a})},_onGraphicOver:function(a){(a=a.graphic._parentGraphic)&&a instanceof G.Graphic.Cluster&&this.fireEvent("clusterOver",{cluster:a})},_onGraphicOut:function(a){(a=a.graphic._parentGraphic)&&a instanceof G.Graphic.Cluster&&this.fireEvent("clusterOut",{cluster:a})},_draw:function(){var a=this._map;"canvas"==a._mode?this._drawCanvas():"svg"==a._mode?this._drawSvg():"vml"==a._mode&&this._drawVml()},_drawCanvas:function(){var a=this._map,c=this._ctx=a._useOffScreen?a._offScreenCtx:a._onScreenCtx;
c.save();var b=a.getCenter(),e=a._res,f=a.getDrawSize(),g=f[0],f=f[1],a=G.ExtentUtil.intersect([b[0]-g*e/2,b[1]-f*e/2,b[0]+g*e/2,b[1]+f*e/2],a.options.maxExtent),b=this._calcNearestZoom(),g=this._clusteredTrees[b],e=this._unclusteredTrees[b];this._showRelZoom&&b>=this._showRelZoom&&(g=null,e=this._tree);var d,k,l,h;h=this._tree.search(a);for(d in h)k=h[d],k.options.clickable=!1;f=0;for(l=this._clusteredTrees.length;f<l;f++)for(d in h=this._clusteredTrees[f].search(a),h)k=h[d],k._offClickable();f=
0;for(l=this._unclusteredTrees.length;f<l;f++)for(d in h=this._unclusteredTrees[f].search(a),h)k=h[d],k.options.clickable=!1;if(g)for(d in h=g.search(a).sort(this._sortIndex),h)k=h[d],k._onClickable(),g=k.bbox,k._draw&&(k._layer&&G.ExtentUtil.overlaps(g,a))&&k._draw();h=e.search(a).sort(this._sortIndex);for(d in h)k=h[d],k._parentGraphic||(k.options.clickable=this.options.pointClickable,g=k.bbox,k._draw&&(k._layer&&G.ExtentUtil.overlaps(g,a))&&k._draw());c.restore();this._zoom=b},_drawSvg:function(){var a=
this._map,c=G.DomUtil,b=this._svg,e=c.getPosition(a._mapFrame),f=a.getSize(),g=a.getDrawSize(),d=g[0],g=g[1],k=(d-f[0])/2,f=(g-f[1])/2;c.setZIndex(this._container,this._zIndex);c.show(b);b.style[c.Transform]=c.genTranslateStyle(-k,-f);b.setAttribute("width",d);b.setAttribute("height",g);b.setAttribute("viewBox",[-e[0],-e[1],d,g].join(" "));c=a.getCenter();b=a._res;a=G.ExtentUtil.intersect([c[0]-d*b/2,c[1]-g*b/2,c[0]+d*b/2,c[1]+g*b/2],a.options.maxExtent);d=this._calcNearestZoom();b=this._clusteredTrees[d];
g=this._unclusteredTrees[d];this._showRelZoom&&d>=this._showRelZoom&&(b=null,g=this._tree);var l,h,c=this._tree.all();for(l in c)h=c[l],h._updateDomViz(!1);e=0;for(f=this._clusteredTrees.length;e<f;e++)for(l in c=this._clusteredTrees[e].all(),c)h._updateDomViz(!1);e=0;for(f=this._unclusteredTrees.length;e<f;e++)for(l in c=this._unclusteredTrees[e].all(),c)h=c[l],h._updateDomViz(!1);if(b)for(l in c=b.search(a).sort(this._sortIndex),c)h=c[l],h._onClickable(),b=h.bbox,h._layer&&G.ExtentUtil.overlaps(b,
a)&&(h._updatePoints(!0),h._updateStyles(),h._updateDomViz(!0));c=g.search(a).sort(this._sortIndex);for(l in c)h=c[l],h._parentGraphic||(h.options.clickable=this.options.pointClickable,b=h.bbox,h._layer&&G.ExtentUtil.overlaps(b,a)&&(h._updatePoints(!0),h._updateStyles(),h._updateDomViz(!0)));this._zoom=d},_drawVml:function(){var a=this._map,c=G.DomUtil,b=a.getDrawSize(),e=b[0],b=b[1],f=this._vml;c.setZIndex(this._container,this._zIndex);c.show(f);f.style.width=e;f.style.height=b;f.coordsize=[e,b].join(" ");
c=a.getCenter();f=a._res;a=G.ExtentUtil.intersect([c[0]-e*f/2,c[1]-b*f/2,c[0]+e*f/2,c[1]+b*f/2],a.options.maxExtent);e=this._calcNearestZoom();f=this._clusteredTrees[e];b=this._unclusteredTrees[e];this._showRelZoom&&e>=this._showRelZoom&&(f=null,b=this._tree);var g,d,k,l,c=this._tree.all();for(g in c)d=c[g],d._updateDomViz(!1);k=0;for(l=this._clusteredTrees.length;k<l;k++)for(g in c=this._clusteredTrees[k].all(),c)d._updateDomViz(!1);k=0;for(l=this._unclusteredTrees.length;k<l;k++)for(g in c=this._unclusteredTrees[k].all(),
c)d=c[g],d._updateDomViz(!1);if(f)for(g in c=f.search(a).sort(this._sortIndex),c)d=c[g],d._onClickable(),f=d.bbox,d._layer&&G.ExtentUtil.overlaps(f,a)&&(d._updatePoints(!0),d._updateStyles(),d._updateDomViz(!0));c=b.search(a).sort(this._sortIndex);for(g in c)d=c[g],d._parentGraphic||(d.options.clickable=this.options.pointClickable,f=d.bbox,d._layer&&G.ExtentUtil.overlaps(f,a)&&(d._updatePoints(!0),d._updateStyles(),d._updateDomViz(!0)));this._zoom=e}});
