G.Layer.Heat=G.Layer.extend({options:{radius:30,radiusUnit:"pixel",maxOpacity:1,minOpacity:0,colors:{"0.2":"#00f","0.4":"#0ff","0.6":"#0f0","0.8":"#ff0",1:"#f00"},topValue:1,drawOnAnim:!1},init:function(a){this.options=G.Util.merge({},this.options,a);this._idSeq=0;this._dataPoints={};this._tree=new G.RTree;this._updateColorsImage();this._dirty=!0;this._builtExtent=[]},_onResize:function(){var a=this._map,a=(a._useOffScreen?a._offScreenCtx:a._onScreenCtx).canvas,b=this._ctx.canvas,c=this._actx.canvas,
d=G.Browser.getCanvasRatio(),g=d?d[0]||1:1,d=d?d[1]||1:1;b.width=a.width;b.height=a.height;c.width=a.width/g;c.height=a.height/d;this._dirty=!0},_initContainer:function(){var a=this._map,b=G.DomUtil;this._ctx||(this._ctx=b.create("canvas").getContext("2d"));this._actx||(this._actx=b.create("canvas").getContext("2d"));this._cctx||(this._cctx=G.DomUtil.create("canvas").getContext("2d"));a.addListener("resize",this._onResize,this);a.addListener("moveEnd",this._onExtentChanged,this);a.addListener("zoomEnd",
this._onExtentChanged,this);this._onResize()},_onAdded:function(){var a=this._map;this._initContainer();a._requestUpdate()},_onRemoved:function(){var a=this._map;a.removeListener("resize",this._onResize,this);a.removeListener("moveEnd",this._onExtentChanged,this);a.removeListener("zoomEnd",this._onExtentChanged,this)},_onExtentChanged:function(a){a=this._map;var b=a.getExtent();G.ExtentUtil.equals(b,this._builtExtent,2*a._res)||(this._dirty=!0)},updateColors:function(){this._updateColorsImage()},
addDataPoint:function(a,b,c,d){var g=this._map,f=[a,b,a,b];a={x:a,y:b,data:c||1};a.bbox=f;a._id=this._idSeq++;a._addAt=+new Date;this._dataPoints[a._id]=a;this._tree.insert(f,a);this._dirty=!0;d&&g&&g._requestRedraw();return a._id},removeDataPoint:function(a,b){var c=this._map,d=this._dataPoints[a];if(!d)return this;delete this._dataPoints[a];this._tree.remove(d.bbox,d);this._dirty=!0;b&&c&&c._requestRedraw();return this},clear:function(a){var b=this._map;this._dataPoints={};this._tree.clear();this._dirty=
!0;!a&&b&&b._requestRedraw();return this},_update:function(){this._draw()},_draw:function(){var a=this._map,b=this.options,c=this._ctx,d=c.canvas,g=d.width,d=d.height;if(this._dirty){var f=b.radius;"pixel"==b.radiusUnit&&(f*=a._res);var e=a.getCenter(),m=a._res,h=a.getDrawSize(),l=h[0],h=h[1],f=G.ExtentUtil.intersect([e[0]-l*m/2-f,e[1]-h*m/2-f,e[0]+l*m/2+f,e[1]+h*m/2+f],a.options.maxExtent);if(!b.drawOnAnim&&(a.isZooming()||a.isPinching()||a.isRotating()||a.isPanning()))return;f=this._tree.search(f);
if(!f)return;var k,e=this._actx,l=e.canvas,m=l.width,h=l.height;e.clearRect(0,0,m,h);for(k in f)l=f[k],this._drawA(l.x,l.y,l.data);var f=e.getImageData(0,0,m,h),e=f.data,m=e.length,l=Math.min(parseInt(255*b.maxOpacity),255),b=Math.min(l,Math.min(parseInt(255*b.minOpacity),255)),h=this._colorsImage,p,n;for(k=0;k<m-3;k+=4)(p=e[k+3])?(n=4*p,e[k]=h[n],e[k+1]=h[n+1],e[k+2]=h[n+2],e[k+3]=b+(l-b)*p/255):0<b&&(e[k]=h[0],e[k+1]=h[1],e[k+2]=h[2],e[k+3]=b);f.data=e;c.clearRect(0,0,g,d);c.putImageData(f,0,0,
0,0,g,d);this._dirty=!1;this._builtExtent=a.getExtent()}this._hidden||(a=a._useOffScreen?a._offScreenCtx:a._onScreenCtx,g=a.canvas,a.drawImage(c.canvas,0,0,g.width,g.height))},_updateColorsImage:function(){var a=G.DomUtil.create("canvas").getContext("2d"),b=a.canvas;b.width=1;b.height=256;var b=this.options.colors,c=a.createLinearGradient(0,0,1,256),d;for(d in b)c.addColorStop(d,b[d]);a.fillStyle=c;a.fillRect(0,0,1,256);this._colorsImage=a.getImageData(0,0,1,256).data},_updateCircle:function(a,b){var c=
this._cctx,d=c.canvas,g=a+2*b,f=2*g;d.width=d.height=2*g;c.shadowColor="#000";c.shadowOffsetX=c.shadowOffsetY=f;c.shadowBlur=b;c.beginPath();c.arc(g-f,g-f,a,0,2*Math.PI,!0);c.closePath();c.fill();this._circleRadius=a;this._circleR=g;return this},_drawA:function(a,b,c){var d=this._map,g=this.options;if(c){var f=g.topValue,e=g.radius;"map"==g.radiusUnit&&(e/=d._res);this._circleRadius&&this._circleRadius==e||this._updateCircle(e,e);g=this._actx;e=d._canvasOffset;b=d.toScreen([a,b]);a=b[0]+e[0];b=b[1]+
e[1];c=Math.min(1,c/f);g.globalAlpha=c;g.drawImage(this._cctx.canvas,a-this._circleR,b-this._circleR)}}});
