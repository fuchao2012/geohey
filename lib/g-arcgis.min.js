G.ArcGISUtil={toGraphics:function(f,d){var a,b=f.attributes,e=[],c;if("esriGeometryPoint"==d)a=f.geometry,a=G.Util.isArray(a)?a:[a.x,a.y],e.push(new G.Graphic.Point(a,b));else if("esriGeometryPolyline"==d){var k=f.geometry.paths;for(c in k)a=k[c],e.push(new G.Graphic.Polyline(a,b))}else if("esriGeometryPolygon"==d){var k=f.geometry.rings,g;a=[];for(c in k)g=k[c],g.splice(g.length-1),a.push(g);e.push(new G.Graphic.Polygon(a,b))}return e}};
G.Layer.ArcGISFeature=G.Layer.FeatureService.extend({options:{mode:"tile",maxHandle:1E3,fields:"*",where:"1=1"},init:function(f,d){var a=this;G.Layer.FeatureService.prototype.init.call(a,function(b){var e=f+"/query",c={f:"json",where:a.options.where,outFields:a.options.fields,inSR:a._map?a._map.options.srid:"",outSR:a._map?a._map.options.srid:""};"tile"==a.options.mode&&(c.geometryType="esriGeometryEnvelope",c.geometry=b[0]+","+b[1]+","+b[2]+","+b[3]);c={responseType:"http"===e.slice(0,4).toLowerCase()?
"JSONP":"JSON",data:c,success:function(c,g){var e=g.geometryType,f=g.objectIdFieldName,d=g.features;if(d){var l;l=d.length-1;for(var r=Math.max(0,l-a.options.maxHandle),h,p,m,n,q;l>=r;l--)for(n in h=d[l],p=h.attributes||{},m=G.ArcGISUtil.toGraphics(h,e),m)if(q=m[n])h=p[f]+"_"+n,a.get(h)||q.addTo(a,h);a.onSuccess(b)}},error:function(){a.onError(b)},complete:function(){a.onComplete(b)}};G.Util.ajax(e,c)},d)}});
