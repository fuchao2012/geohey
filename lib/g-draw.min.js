G.Layer.Draw=G.Layer.Graphic.extend({forbidKeys:["DoubleClick","Pinch","Drag","ShiftDrag"],startDraw:function(a,d){var b=this._map;this._handler&&this._handler.off();this._drawOptions=G.Util.merge(d||{},{clickable:!1});"circle"==a?this._handler=(new G.DrawHandler.Circle(this)).on():"point"==a?this._handler=(new G.DrawHandler.Point(this)).on():"polyline"==a?this._handler=(new G.DrawHandler.Polyline(this)).on():"freepolyline"==a?this._handler=(new G.DrawHandler.Freepolyline(this)).on():"polygon"==a?
this._handler=(new G.DrawHandler.Polygon(this)).on():"freepolygon"==a?this._handler=(new G.DrawHandler.Freepolygon(this)).on():"rect"==a?this._handler=(new G.DrawHandler.Rect(this)).on():"arrow"==a&&(this._handler=(new G.DrawHandler.Arrow(this)).on());if(this._drawing)return this;G.DomUtil.addClass(b._layersFrame,"g-edit");this._drawing=!0;var c,f,e=this.forbidKeys;for(c in e)if(f=e[c],f=b._handlers[f])f._forbidden=!0,f.off();return this},endDraw:function(){var a=this._map,d,b,c;if(this._drawing){(c=
this._handler)&&c.off();delete c._graphic;this._drawing=!1;b=this.forbidKeys;for(d in b)if(c=b[d],c=a._handlers[c])c._forbidden=!1;a._resetHandlers();G.DomUtil.removeClass(a._layersFrame,"g-edit")}return this}});
G.DrawHandler=G.Class.extend({mixins:[G.Event],init:function(a){this._layer=a;this._enabled=!1;return this},on:function(){this._enabled||(this._enabled=!0,delete this._graphic,this.afterOn());return this},off:function(){if(this._enabled){this._enabled=!1;var a=this._graphic,d=this._layer;a&&(d&&d._drawing&&(a instanceof G.Graphic.Polyline||a instanceof G.Graphic.Polygon))&&d.fireEvent("drawEnd",{graphic:a});this.afterOff()}return this},afterOn:function(){},afterOff:function(){}});
G.DrawHandler.Circle=G.DrawHandler.extend({afterOn:function(){var a=this._layer._map,d=this.virtualMouse,b;for(b in d.DOWN)a.addListener(d.DOWN[b],this._onDown,this)},afterOff:function(){var a=this._layer._map,d=this.virtualMouse,b;for(b in d.DOWN)a.removeListener(d.DOWN[b],this._onDown,this),a.removeListener(d.MOVE[b],this._onMove),a.removeListener(d.UP[b],this._onUp)},_onDown:function(a){var d=this._layer,b=d._map,c=G.DomUtil;c.stopPropagation(a);c.preventDefault(a);c.disableImageDrag();c.disableTextSelection();
c=this.virtualMouse;b.addListener(c.MOVE[a.type],this._onMove,this);b.addListener(c.UP[a.type],this._onUp,this);var f=[a.mapX,a.mapY],c=[0,0];b.options.wrap&&(f=b._calcRealCoords(f),c=[f[0]-a.mapX,f[1]-a.mapY]);a=this._graphic=(new G.Graphic.Circle([f[0],f[1],0],null,d._drawOptions)).addTo(d);a._wrapOffset=c;d.fireEvent("drawStart",{graphic:a})},_onMove:function(a){var d=this._layer,b=d._map,c=G.DomUtil;c.stopPropagation(a);c.preventDefault(a);var c=this._graphic,f=c.geom;a=[a.mapX,a.mapY];if(b.options.wrap){var e=
c._wrapOffset;a[0]+=e[0];a[1]+=e[1]}a=G.MathUtil.calcHypotenuse(a[0]-f[0],a[1]-f[1]);f[2]=a;c.updateGeom();b._requestRedraw();d.fireEvent("draw",{graphic:c})},_onUp:function(a){var d=this._layer,b=d._map,c=G.DomUtil;c.stopPropagation(a);c.preventDefault(a);a=this.virtualMouse;for(var f in a.MOVE)b.removeListener(a.MOVE[f],this._onMove),b.removeListener(a.UP[f],this._onUp);d.fireEvent("drawEnd",{graphic:this._graphic})}});
G.DrawHandler.Point=G.DrawHandler.extend({afterOn:function(){this._layer._map.addListener("click",this._onClick,this)},afterOff:function(){this._layer._map.removeListener("click",this._onClick,this)},_onClick:function(a){var d=this._layer;a=[a.mapX,a.mapY];map.options.wrap&&(a=map._calcRealCoords(a));a=this._graphic=(new G.Graphic.Point(a,null,d._drawOptions)).addTo(d);d.fireEvent("drawStart",{graphic:a}).fireEvent("draw",{graphic:a}).fireEvent("drawEnd",{graphic:a})}});
G.DrawHandler.Polyline=G.DrawHandler.extend({afterOn:function(){var a=this._layer._map;a.addListener("virtualclick",this._onClick,this);a.addListener("doubleclick",this._onDoubleClick,this)},afterOff:function(){var a=this._layer._map,d=this.virtualMouse,b;for(b in d.MOVE)a.removeListener(d.MOVE[b],this._onMove,this);a.removeListener("virtualclick",this._onClick,this);a.removeListener("doubleclick",this._onDoubleClick,this)},_onClick:function(a){var d=this._layer,b=d._map,c=G.DomUtil,f=this.virtualMouse;
c.stopPropagation(a);c.preventDefault(a);var c=this._graphic,e=[a.mapX,a.mapY],h;if(c)this._ptIndex++,b.options.wrap&&(g=c._wrapOffset,e[0]+=g[0],e[1]+=g[1]),a=c.geom,a[this._ptIndex]=e,c.updateGeom(),b._requestRedraw(),d.fireEvent("draw",{graphic:c});else{var g=[0,0];b.options.wrap&&(e=b._calcRealCoords(e),g=[e[0]-a.mapX,e[1]-a.mapY]);a=[e,e];c=this._graphic=(new G.Graphic.Polyline(a,null,d._drawOptions)).addTo(d);c._wrapOffset=g;this._ptIndex=0;for(h in f.MOVE)b.addListener(f.MOVE[h],this._onMove,
this);this._realDoubleZoom=b.options.doubleZoom;b.options.doubleZoom=!1;b._requestRedraw();d.fireEvent("drawStart",{graphic:c})}},_onMove:function(a){var d=this._layer._map,b=G.DomUtil;b.stopPropagation(a);b.preventDefault(a);b=this._graphic;a=[a.mapX,a.mapY];var c;b&&(d.options.wrap&&(c=b._wrapOffset,a[0]+=c[0],a[1]+=c[1]),c=b.geom,c[this._ptIndex+1]=a,b.updateGeom(),d._requestRedraw())},_onDoubleClick:function(a){var d=this._layer,b=d._map,c=G.DomUtil,f=this.virtualMouse;c.stopPropagation(a);c.preventDefault(a);
for(var e in f.MOVE)b.removeListener(f.MOVE[e],this._onMove,this);a=this._graphic;delete this._graphic;b.options.doubleZoom=this._realDoubleZoom||b.options.doubleZoom;a&&(a.geom&&2<a.geom.length&&(a.geom.splice(a.geom.length-1),a.updateGeom()),b._requestRedraw(),d.fireEvent("drawEnd",{graphic:a}))}});
G.DrawHandler.Freepolyline=G.DrawHandler.extend({afterOn:function(){var a=this._layer._map,d=this.virtualMouse,b;for(b in d.DOWN)a.addListener(d.DOWN[b],this._onDown,this)},afterOff:function(){var a=this._layer._map,d=this.virtualMouse,b;for(b in d.DOWN)a.removeListener(d.DOWN[b],this._onDown,this),a.removeListener(d.MOVE[b],this._onMove),a.removeListener(d.UP[b],this._onUp)},_onDown:function(a){var d=this._layer,b=d._map,c=G.DomUtil;c.stopPropagation(a);c.preventDefault(a);c.disableImageDrag();c.disableTextSelection();
c=this.virtualMouse;b.addListener(c.MOVE[a.type],this._onMove,this);b.addListener(c.UP[a.type],this._onUp,this);var f=this._graphic,e=[a.mapX,a.mapY];if(!f){var h=[0,0];b.options.wrap&&(e=b._calcRealCoords(e),h=[e[0]-a.mapX,e[1]-a.mapY]);a=[e];f=this._graphic=(new G.Graphic.Polyline(a,null,d._drawOptions)).addTo(d);f._wrapOffset=h}for(var g in c.MOVE)b.addListener(c.MOVE[g],this._onMove,this);d.fireEvent("drawStart",{graphic:f})},_onMove:function(a){var d=this._layer,b=d._map,c=G.DomUtil;c.stopPropagation(a);
c.preventDefault(a);var c=this._graphic,f=c.geom,e=f.length;f[e]=[a.mapX,a.mapY];b.options.wrap&&(a=c._wrapOffset,f[e][0]+=a[0],f[e][1]+=a[1]);c.updateGeom();b._requestRedraw();d.fireEvent("draw",{graphic:c})},_onUp:function(a){var d=this._layer,b=d._map,c=G.DomUtil;c.stopPropagation(a);c.preventDefault(a);var c=this._graphic,f=c.geom,e=f.length;f[e]=[a.mapX,a.mapY];b.options.wrap&&(a=c._wrapOffset,f[e][0]+=a[0],f[e][1]+=a[1]);c.updateGeom();b._requestRedraw();a=this.virtualMouse;for(var h in a.MOVE)b.removeListener(a.MOVE[h],
this._onMove),b.removeListener(a.UP[h],this._onUp);delete this._graphic;d.fireEvent("drawEnd",{graphic:c})}});
G.DrawHandler.Polygon=G.DrawHandler.extend({afterOn:function(){var a=this._layer._map;a.addListener("virtualclick",this._onClick,this);a.addListener("doubleclick",this._onDoubleClick,this)},afterOff:function(){var a=this._layer._map,d=this.virtualMouse,b;for(b in d.MOVE)a.removeListener(d.MOVE[b],this._onMove,this);a.removeListener("virtualclick",this._onClick,this);a.addListener("doubleclick",this._onDoubleClick,this)},_onClick:function(a){var d=this._layer,b=d._map,c=G.DomUtil,f=this.virtualMouse;
c.stopPropagation(a);c.preventDefault(a);var c=this._graphic,e=[a.mapX,a.mapY],h;if(c)this._ptIndex++,b.options.wrap&&(g=c._wrapOffset,e[0]+=g[0],e[1]+=g[1]),a=c.geom,a[0][this._ptIndex]=e,c.updateGeom(),b._requestRedraw(),d.fireEvent("draw",{graphic:c});else{var g=[0,0];b.options.wrap&&(e=b._calcRealCoords(e),g=[e[0]-a.mapX,e[1]-a.mapY]);a=[[e,e]];c=this._graphic=(new G.Graphic.Polygon(a,null,d._drawOptions)).addTo(d);c._wrapOffset=g;this._ptIndex=0;for(h in f.MOVE)b.addListener(f.MOVE[h],this._onMove,
this);this._realDoubleZoom=b.options.doubleZoom;b.options.doubleZoom=!1;b._requestRedraw();d.fireEvent("drawStart",{graphic:c})}},_onMove:function(a){var d=this._layer._map,b=G.DomUtil;b.stopPropagation(a);b.preventDefault(a);b=this._graphic;a=[a.mapX,a.mapY];var c;b&&(d.options.wrap&&(c=b._wrapOffset,a[0]+=c[0],a[1]+=c[1]),c=b.geom,c[0][this._ptIndex+1]=a,b.updateGeom(),d._requestRedraw())},_onDoubleClick:function(a){var d=this._layer,b=d._map,c=G.DomUtil,f=this.virtualMouse;c.stopPropagation(a);
c.preventDefault(a);for(var e in f.MOVE)b.removeListener(f.MOVE[e],this._onMove,this);a=this._graphic;delete this._graphic;b.options.doubleZoom=this._realDoubleZoom||b.options.doubleZoom;a&&(a.geom&&(a.geom[0]&&3<a.geom[0].length)&&(a.geom[0].splice(a.geom[0].length-1),a.updateGeom()),b._requestRedraw(),d.fireEvent("drawEnd",{graphic:a}))}});
G.DrawHandler.Freepolygon=G.DrawHandler.extend({afterOn:function(){var a=this._layer._map,d=this.virtualMouse,b;for(b in d.DOWN)a.addListener(d.DOWN[b],this._onDown,this)},afterOff:function(){var a=this._layer._map,d=this.virtualMouse,b;for(b in d.DOWN)a.removeListener(d.DOWN[b],this._onDown,this),a.removeListener(d.MOVE[b],this._onMove),a.removeListener(d.UP[b],this._onUp)},_onDown:function(a){var d=this._layer,b=d._map,c=G.DomUtil;c.stopPropagation(a);c.preventDefault(a);c.disableImageDrag();c.disableTextSelection();
c=this.virtualMouse;b.addListener(c.MOVE[a.type],this._onMove,this);b.addListener(c.UP[a.type],this._onUp,this);var f=this._graphic,e=[a.mapX,a.mapY];if(!f){var h=[0,0];b.options.wrap&&(e=b._calcRealCoords(e),h=[e[0]-a.mapX,e[1]-a.mapY]);a=[[e]];f=this._graphic=(new G.Graphic.Polygon(a,null,d._drawOptions)).addTo(d);f._wrapOffset=h}for(var g in c.MOVE)b.addListener(c.MOVE[g],this._onMove,this);d.fireEvent("drawStart",{graphic:f})},_onMove:function(a){var d=this._layer,b=d._map,c=G.DomUtil;c.stopPropagation(a);
c.preventDefault(a);var c=this._graphic,f=c.geom[0],e=f.length;f[e]=[a.mapX,a.mapY];b.options.wrap&&(a=c._wrapOffset,f[e][0]+=a[0],f[e][1]+=a[1]);c.updateGeom();b._requestRedraw();d.fireEvent("draw",{graphic:c})},_onUp:function(a){var d=this._layer,b=d._map,c=G.DomUtil;c.stopPropagation(a);c.preventDefault(a);var c=this._graphic,f=c.geom[0],e=f.length;f[e]=[a.mapX,a.mapY];b.options.wrap&&(a=c._wrapOffset,f[e][0]+=a[0],f[e][1]+=a[1]);c.updateGeom();b._requestRedraw();a=this.virtualMouse;for(var h in a.MOVE)b.removeListener(a.MOVE[h],
this._onMove),b.removeListener(a.UP[h],this._onUp);delete this._graphic;d.fireEvent("drawEnd",{graphic:c})}});
G.DrawHandler.Rect=G.DrawHandler.extend({afterOn:function(){var a=this._layer._map;a.addListener("virtualclick",this._onClick,this);a.addListener("doubleclick",this._onDoubleClick,this)},afterOff:function(){var a=this._layer._map,d=this.virtualMouse,b;for(b in d.MOVE)a.removeListener(d.MOVE[b],this._onMove,this);a.removeListener("virtualclick",this._onClick,this);a.addListener("doubleclick",this._onDoubleClick,this)},_onClick:function(a){var d=this._layer,b=d._map,c=G.DomUtil,f=this.virtualMouse;
c.stopPropagation(a);c.preventDefault(a);var c=this._graphic,e=[a.mapX,a.mapY],h;if(c)b.options.wrap&&(g=c._wrapOffset,e[0]+=g[0],e[1]+=g[1]),this._p2?a=this._genRect(this._p1,this._p2,e):(this._p2=e,a=[[this._p1,e,e]]),c.updateGeom(a),b._requestRedraw(),d.fireEvent("draw",{graphic:c});else{var g=[0,0];b.options.wrap&&(e=b._calcRealCoords(e),g=[e[0]-a.mapX,e[1]-a.mapY]);this._p1=e;a=[[e,e,e]];c=this._graphic=(new G.Graphic.Polygon(a,null,d._drawOptions)).addTo(d);c._wrapOffset=g;for(h in f.MOVE)b.addListener(f.MOVE[h],
this._onMove,this);this._realDoubleZoom=b.options.doubleZoom;b.options.doubleZoom=!1;b._requestRedraw();d.fireEvent("drawStart",{graphic:c})}},_onMove:function(a){var d=this._layer._map,b=G.DomUtil;b.stopPropagation(a);b.preventDefault(a);b=this._graphic;a=[a.mapX,a.mapY];var c=this._p1,f=this._p2;if(b&&c){if(d.options.wrap){var e=b._wrapOffset;a[0]+=e[0];a[1]+=e[1]}a=f?this._genRect(c,f,a):[[c,a,a]];b.updateGeom(a);d._requestRedraw()}},_onDoubleClick:function(a){var d=this._layer,b=d._map,c=G.DomUtil,
f=this.virtualMouse;c.stopPropagation(a);c.preventDefault(a);for(var e in f.MOVE)b.removeListener(f.MOVE[e],this._onMove,this);a=this._graphic;delete this._graphic;delete this._p1;delete this._p2;b.options.doubleZoom=this._realDoubleZoom||b.options.doubleZoom;a&&d.fireEvent("drawEnd",{graphic:a})},_genRect:function(a,d,b){var c=G.MathUtil.calcDistance(d,b);if(0==c)return[[a,d,b]];var f=((a[0]-d[0])*(b[0]-d[0])+(a[1]-d[1])*(b[1]-d[1]))/c/c,c=d[0]+f*(b[0]-d[0]);b=d[1]+f*(b[1]-d[1]);return[[a,[c,b],
d,[a[0]+d[0]-c,a[1]+d[1]-b]]]}});
G.DrawHandler.Arrow=G.DrawHandler.extend({afterOn:function(){var a=this._layer._map;a.addListener("virtualclick",this._onClick,this);a.addListener("doubleclick",this._onDoubleClick,this)},afterOff:function(){var a=this._layer._map,d=this.virtualMouse,b;for(b in d.MOVE)a.removeListener(d.MOVE[b],this._onMove,this);a.removeListener("virtualclick",this._onClick,this);a.removeListener("doubleclick",this._onDoubleClick,this)},_onClick:function(a){var d=this._layer,b=d._map,c=G.DomUtil,f=this.virtualMouse;
c.stopPropagation(a);c.preventDefault(a);var c=this._graphic,e=[a.mapX,a.mapY],h;if(c)this._ptIndex++,b.options.wrap&&(g=c._wrapOffset,e[0]+=g[0],e[1]+=g[1]),a=c.geom,a[this._ptIndex]=e,c.updateGeom(),b._requestRedraw(),d.fireEvent("draw",{graphic:c});else{var g=[0,0];b.options.wrap&&(e=b._calcRealCoords(e),g=[e[0]-a.mapX,e[1]-a.mapY]);a=[e,e];c=this._graphic=(new G.Graphic.Arrow(a,null,d._drawOptions)).addTo(d);c._wrapOffset=g;this._ptIndex=0;for(h in f.MOVE)b.addListener(f.MOVE[h],this._onMove,
this);this._realDoubleZoom=b.options.doubleZoom;b.options.doubleZoom=!1;b._requestRedraw();d.fireEvent("drawStart",{graphic:c})}},_onMove:function(a){var d=this._layer._map,b=G.DomUtil;b.stopPropagation(a);b.preventDefault(a);b=this._graphic;a=[a.mapX,a.mapY];var c;b&&(d.options.wrap&&(c=b._wrapOffset,a[0]+=c[0],a[1]+=c[1]),c=b.geom,c[this._ptIndex+1]=a,b.updateGeom(),d._requestRedraw())},_onDoubleClick:function(a){var d=this._layer,b=d._map,c=G.DomUtil,f=this.virtualMouse;c.stopPropagation(a);c.preventDefault(a);
for(var e in f.MOVE)b.removeListener(f.MOVE[e],this._onMove,this);a=this._graphic;delete this._graphic;b.options.doubleZoom=this._realDoubleZoom||b.options.doubleZoom;a&&(a.geom&&2<a.geom.length&&(a.geom.splice(a.geom.length-1),a.updateGeom()),b._requestRedraw(),d.fireEvent("drawEnd",{graphic:a}))}});
