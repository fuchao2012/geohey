G.Layer.Fluid=G.Layer.extend({options:{gridPixels:4,gridMaxDivs:200,gridReduceFactor:2,fieldFactor:0.8,fieldMaxIntensity:50,particleMaxAge:100,particleCountFactor:0.05,lineWidth:1.2,opacity:1,colors:["#fff","#fff","#fff","#fff","#fff"],searchSteps:3,interpolateCount:4,frameDuration:50},init:function(a){this.options=G.Util.merge({},this.options,a);this._idSeq=0;this._dataPoints={};this._tree=new G.RTree;this._nullVector=[NaN,NaN,null];this._dirty=!0;this._builtExtent=[]},start:function(){this._buildGrid();
this._startAnim();return this},stop:function(){clearTimeout(this._timer);this._playing=!1;return this},isPlaying:function(){return this._playing},_startAnim:function(){var a=this,b=a._map,c=a.options;a._playing=!0;(function d(){try{clearTimeout(a._timer),a._timer=setTimeout(function(){G.Util.requestAnimFrame(d);a._evolve();b._requestRedraw()},c.frameDuration)}catch(f){console.error(f)}})()},_onReize:function(){var a=this._map,a=(a._useOffScreen?a._offScreenCtx:a._onScreenCtx).canvas,b=this._ctx,c=
b.canvas,e=G.Browser.getCanvasRatio();b.scale(e?e[0]||1:1,e?e[1]||1:1);c.width=a.width;c.height=a.height;this._dirty=!0},_onExtentChanged:function(a){a=this._map;var b=a.getExtent();G.ExtentUtil.equals(b,this._builtExtent,2*a._res)||(this._dirty=!0)},_initContainer:function(){var a=this._map,b=G.DomUtil;this._ctx||(this._ctx=b.create("canvas").getContext("2d"));a.addListener("resize",this._onReize,this);a.addListener("moveEnd",this._onExtentChanged,this);a.addListener("zoomEnd",this._onExtentChanged,
this);this._onReize()},_onAdded:function(){var a=this._map;this._initContainer();a._requestUpdate()},_onRemoved:function(){var a=this._map;a.removeListener("resize",this._onReize,this);a.removeListener("moveEnd",this._onExtentChanged,this);a.removeListener("zoomEnd",this._onExtentChanged,this)},addDataPoint:function(a,b,c,e,d){var f=this._map,g=[a,b,a,b];a={x:a,y:b,u:c||0,v:e||0};a.bbox=g;a._id=this._idSeq++;a._addAt=+new Date;this._dataPoints[a._id]=a;this._tree.insert(g,a);this._dirty=!0;d&&f&&
f._requestRedraw();return a._id},removeDataPoint:function(a,b){var c=this._map,e=this._dataPoints[a];if(!e)return this;delete this._dataPoints[a];this._tree.remove(e.bbox,e);this._dirty=!0;b&&c&&c._requestRedraw();return this},clear:function(a){var b=this._map;this._dataPoints={};this._tree.clear();this._particles=null;this._erase();this._dirty=!0;!a&&b&&b._requestRedraw();return this},calcField:function(a,b){var c=this._map,e=c.options.maxExtent,d=this._tree.all(),d=d&&d.length,f=Math.sqrt(d)||1,
e=Math.max(e[2]-e[0],e[3]-e[1])/f;a=c._calcRealCoords([a,b])[0];if(0<d){c=1;do f=[a-c*e,b-c*e,a+c*e,b+c*e],d=this._tree.search(f),c*=2;while(!d||0==d.length);return this._interpolate(a,b,f)}return this._nullVector},hide:function(){var a=this._map;if(this._hidden)return this;this._hidden=!0;this._erase();a&&a._requestRedraw();return this},_update:function(){this._draw()},_erase:function(){var a=this._ctx,b=a.canvas;a.clearRect(0,0,b.width,b.height)},_draw:function(){var a=this,b=a._map,c=a.options,
e=a._ctx;a._dirty&&(a._erase(),a._playing&&setTimeout(function(){a._buildGrid();a._particles=null;a._startAnim()},c.frameDuration));if(a._playing){var d=a._particles;if(!d)for(var d=a._particles=[],f=a._gridColCount*a._gridRowCount*c.particleCountFactor,g=0;g<f;g++)d.push(a._createParticle());a._evolve();if(!a._batches)return;d=e.canvas;g=d.width;f=d.height;d=b._canvasOffset;e.globalCompositeOperation="destination-in";e.globalAlpha=0.75;e.fillRect(0,0,g,f);e.globalCompositeOperation="source-over";
e.globalAlpha=c.opacity;e.lineWidth=c.lineWidth;var f=b.options.maxExtent,h=a._gridExtent,l=a._gridSize,k,n,q,r,p,m,s,t,u,g=0;for(n=a._batches.length;g<n;g++){k=a._batches[g];e.beginPath();e.strokeStyle=c.colors[g];q=0;for(r=k.length;q<r;q++)p=k[q],m=h[0]+l*p.x,s=h[1]+l*p.y,t=h[0]+l*p.xt,u=h[1]+l*p.yt,f&&(m<f[0]||m>f[2])||(m=b.toScreen([m,s]),e.moveTo(m[0]+d[0],m[1]+d[1]),m=b.toScreen([t,u]),e.lineTo(m[0]+d[0],m[1]+d[1]),p.x=p.xt,p.y=p.yt);e.stroke()}}a._hidden||(b=b._useOffScreen?b._offScreenCtx:
b._onScreenCtx,c=b.canvas,b.drawImage(e.canvas,0,0,c.width,c.height))},_createParticle:function(a){return{x:Math.round(Math.random()*this._gridColCount),y:Math.round(Math.random()*this._gridRowCount),age:void 0===a?Math.floor(Math.random()*this.options.particleMaxAge):a}},_field:function(a,b){var c=Math.round,e=this._grid[c(b)];return e&&e[c(a)]||this._nullVector},_evolve:function(){var a=this.options,b=this._particles;if(b){for(var c=a.colors.map(function(){return[]}),e=a.fieldFactor/a.fieldMaxIntensity,
d,f,g,h,l=0,k=b.length;l<k;l++)d=b[l],d.age>a.particleMaxAge&&(d=b[l]=this._createParticle(0)),f=d.x,g=d.y,h=this._field(f,g),h[2]?(d.xt=f+h[0]*e,d.yt=g+h[1]*e,c[this._colorIndex(h[2])].push(d)):d=b[l]=this._createParticle(0),d.age++;this._batches=c}},_buildGrid:function(){var a=this._map,b=this.options;if(a&&this._dirty){var c=this._gridExtent=a.getExtent(),e=a.options.maxExtent||c,d=a.getSize(),d=Math.max(d[0],d[1]),d=Math.min(d/b.gridPixels,b.gridMaxDivs);G.Browser.mobile&&(d/=b.gridReduceFactor);
var d=this._gridSize=Math.max(c[2]-c[0],c[3]-c[1])/d,f=this._tree.search(c),f=Math.sqrt(f&&f.length)||1,f=Math.max(c[2]-c[0],c[3]-c[1])/f,g,h;this._gridColCount=Math.ceil((c[2]-c[0])/d);this._gridRowCount=Math.ceil((c[3]-c[1])/d);for(var l=this._grid=[],k,n,q=0,r=this._gridRowCount+1;q<r;q++)if(n=c[1]+q*d,n>=e[1]&&n<=e[3]){for(var p=[],m=0,s=this._gridColCount+1;m<s;m++)for(k=c[0]+m*d,p[m]=this._interpolate(k,n,[k-f,n-f,k+f,n+f]),h=1;null===p[m][2]&&h<=b.searchSteps;)h*=2,g=h*f,p[m]=this._interpolate(k,
n,[k-g,n-g,k+g,n+g]);l[q]=p}this._dirty=!1;this._builtExtent=a.getExtent()}},_interpolate:function(a,b,c){var e=Math.sqrt,d=this._tree.search(c);if(!d)return this._nullVector;for(var f=0,g=c=0,h,l,k,n=0,q=Math.min(this.options.interpolateCount,d.length);n<q;n++){k=d[n];h=k.x-a;l=k.y-b;if(0==h&&0==l)return a=k.u,b=k.v,[a,b,e(a*a+b*b)];h=h*h+l*l;h=Math.sqrt(1/h);f+=k.u*h;c+=k.v*h;g+=h}return 0<g?(a=f/g,b=c/g,[a,b,e(a*a+b*b)]):this._nullVector},_colorIndex:function(a){var b=this.options,c=b.fieldMaxIntensity;
return Math.floor(Math.min(a,c)/c*(b.colors.length-1))}});
