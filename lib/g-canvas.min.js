G.Layer.Tile=G.Layer.Tile.extend({_initContainer:function(){var a=this._map;this.addListener("tileSuccess",a._requestRedraw,a);this.addListener("allLoaded",a._requestRedraw,a)},_destroyContainer:function(){var a=this._map;this.removeListener("tileSuccess",a._requestRedraw,a);this.removeListener("allLoaded",a._requestRedraw,a)},_update:function(){var a=this._map;if(a._isLoaded()){var b=this._zoom=this._calcNearestZoom(!0),c=this._calcVisTileInfos(!0);a.getSize();var d=a.getCenter(),f=this.options,
e=f.zoomReses[b],k=f.tileSize,l=a.getDrawSize(),m=1+2*a.options.canvasExpandFactor,p=l[0]*m,l=l[1]*m,e=[d[0]-p*e/2,d[1]-l*e/2,d[0]+p*e/2,d[1]+l*e/2],a=a.options.maxExtent,n,q;this._redrawExtent=e;var e=G.ExtentUtil.intersect(e,a),s;for(s in this._tiles)m=this._tiles[s],a=m._info,n=a[0],p=a[1],q=a[2],l=f.zoomReses[q],q!==b&&(this._stopLoadingTile(m),(!f.keepResample||1>f.opacity)&&this._removeTile(s)),m=f.originX+n*k*l,n=f.originX+(n+1)*k*l,q=f.originY-(p+1)*k*l,p=f.originY-p*k*l,(p=G.ExtentUtil.overlaps([m,
q,n,p],e))||this._tileInfoExist(a,c)||this._removeTile(s);b=this._calcTileIndex(d[0],d[1],b);this._sortTileInfos(c,b[0],b[1]);this._addTiles(c);this._draw()}},_draw:function(){var a=this._map,b=this.options,a=this._ctx=a._useOffScreen?a._offScreenCtx:a._onScreenCtx,c,d,f,e,k=this._zoom,l,m=1>b.opacity;m&&(a.save(),a.globalAlpha=b.opacity);for(l in this._tiles)c=this._tiles[l],d=c._info,e=parseInt(d[2]),!c._loaded||(e===k||!b.keepResample||1>b.opacity)||(f=parseInt(d[0]),d=parseInt(d[1]),this._placeTile(c,
f,d,e));for(l in this._tiles)c=this._tiles[l],d=c._info,e=parseInt(d[2]),c._loaded&&e===k&&(f=parseInt(d[0]),d=parseInt(d[1]),this._placeTile(c,f,d,e));m&&a.restore()},_placeTile:function(a,b,c,d){if(a._loaded){var f=Math.round,e=G.MathUtil,k=G.Browser.getPxRatio(),l=k[0],k=k[1],m=this._map,p=m._rotate,n=this.options,q=m.options,s=n.tileSize,r=s*n.zoomReses[d];d=n.tileEnlarge&&(!!(p%90)||G.Browser.gecko||G.Browser.safari);var t=Math.ceil(r/m._res)+(d?2:0);b=n.originX+b*r;c=n.originY-c*r;var r=this._zoomScale||
this._scale,v=this._aroundScreen;r&&1!==r&&(t/=r);if(!(t>4*(s+2)||t<s/8)){var u=s=0,x=q.maxExtent,y=x[2]-x[0];q.wrap&&(q=this._redrawExtent)&&x&&(u=Math.floor((q[0]-n.minX)/y)-1,s=Math.ceil((q[2]-n.maxX)/y)+1);for(n=u;n<=s;n++){u=m.toScreen([b+n*y,c],v,r);q=u[0];u=u[1];x=m._canvasOffset;q+=x[0];u+=x[1];d&&(q-=1,u-=1);q=f(q);u=f(u);x=this._ctx;p&&(x.save(),x.translate(q,u),x.rotate(p/e.DEGREE_PER_RADIAN),x.translate(-q,-u));try{x.drawImage(a,q,u,f(t/l),f(t/k))}catch(z){}p&&x.restore()}}}},_addTiles:function(a){if(0!==
a.length){this._numLoad=a.length;this._numLoadError=this._numLoadSuccess=0;for(var b=this.options,c,d,f,e,k,l=this.options.errorTileUrl||G.Layer.Tile.EMPTY_TILE,m=0,p=a.length;m<p;m++)c=a[m],d=c[0],f=c[1],e=c[2],k=this._getTileName(d,f,e),(c=this._tiles[k])?c.src==l?+new Date-c._responseTime>b.tileLiveMs&&this._loadTile(c,d,f,e):this._numLoadSuccess++:(c=this._getIdleTile(),this._tiles[k]=c,this._loadTile(c,d,f,e))}},_clearBgBuffer:function(){var a,b;for(b in this._tiles)a=this._tiles[b],a=a._info,
a=a[2],a!==this._zoom&&this._removeTile(b)}});G.Layer.Graphic=G.Layer.Graphic.extend({_update:function(){this._draw()},_draw:function(){var a=this._map,b=this._ctx=a._useOffScreen?a._offScreenCtx:a._onScreenCtx;b.save();var a=a.getRedrawExtent(),c=this._tree.search(a).sort(this._sortIndex),d,f,e;for(e in c)d=c[e],f=d.bbox,d._layer&&G.ExtentUtil.overlaps(f,a)&&d._draw();b.restore()}});
G.Layer.Label=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{icons:"",cluster:[],crossOrigin:"*"},init:function(a,b){G.Layer.Graphic.prototype.init.call(this,b);this.url=a;this.options=G.Util.merge({},this.options,b);this._lts={};this._gx=this._gy=10},_initContainer:function(){G.Layer.Graphic.prototype._initContainer.call(this)},_onAdded:function(){this._container||this._initContainer()},_onRemoved:function(){this._container&&this._destroyContainer()},_update:function(){var a=this._map;G.Layer.Graphic.prototype._update.call(this);
if(a._isLoaded()){var b=this._zoom=this._calcNearestZoom(!0),c=a.getCenter();this._clearGrids();a=a._zoomAnim;a&&a._playing||(a=this._calcVisTileInfos(),b=this._calcTileIndex(c[0],c[1],b),this._sortTileInfos(a,b[0],b[1]),this._setLts(a))}},_setLts:function(a){if(a.length){for(var b=[],c,d,f,e,k,l=0,m=a.length;l<m;l++)c=a[l],f=c[0],e=c[1],k=c[2],c=this._getTileName(f,e,k),b.push(c),c in this._lts?(d=this._lts[c],d.loading||d.data||d.ri||this._loadLtI(f,e,k)):this._loadLtI(f,e,k),this._placeLt(c);this._dirtyTileKeys=
this._dirtyTileKeys||[];for(c in this._lts)-1<b.indexOf(c)||(this._stopLoadingLt(c),this._dirtyTileKeys.push(c))}},_checkDirtyTiles:function(){var a=this._dirtyTileKeys,b;if(a&&0<a.length)for(var c=0,d=a.length;c<d;c++)b=a[c],this._removeLt(b);this._dirtyTileKeys=[]},_placeLt:function(a){if((a=this._lts[a])&&a._info&&a.data){var b=a.data.l,c,d,f,e,k,l,m,p,n,q,s,r;for(c in b)for(s in d=b[c],f=Number(d[0]),e=Number(d[1]),d=d[6],f=[f,e],e="imgs"+c,q=a[e],q)e=q[s],k=e[0],l=e[1],m=e[2],p=e[3],n=e[4],r=
e[5],r||(e[5]=r=new G.Graphic.Point(f,null,{shape:"image",size:[l,m],offset:[p,n],image:k,imageGravity:!!d}),r.addTo(this))}},_removeLt:function(a){var b=this._lts[a];if(b&&b._info&&b.data){this._stopLoadingLt(a);var c=b.data.l,d,f,e;for(d in c)for(e in c="imgs"+d,f=b[c],f)c=f[e],(g=c[5])&&g.remove();delete this._lts[a]}},_loadLtI:function(a,b,c){var d=this,f=d._getTileName(a,b,c),e=d._lts[f]=d._lts[f]||{};e._info=[a,b,c];""!==e.data&&(e.loading=!0,a=d._getTileUrl(a,b,c,{d:"i",i:G.Browser.retina?
"@2x":""}),b={},d.options.crossOrigin&&(b.crossOrigin=d.options.crossOrigin),b={responseType:"http"===a.slice(0,4).toLowerCase()?"JSONP":"JSON",header:b,success:function(a,b){e.data=b;d._processLt(f)},error:function(a){404==a.status&&(e.data="")},complete:function(){delete e.ri;e.loading=!1}},d.options.crossOrigin&&(b.responseType="JSON"),a=G.Util.ajax(a,b),e.ri=a)},_processLt:function(a){var b=this._lts[a],c=b.data;if(c){var d=c.l,f=c.b,e=c.i,c=c.bb,k=this.options.icons||"",l,m,p,n,q,s,r,t,v;for(l in d){if(f&&
l in f)for(r=f[l],t=0,v=r.length;t<v;t++)s=r[t],d=s[0],m=s[1],p=s[2],n=s[3],q=s[4],s=s[5],0!=s&&c&&(q=c.slice(q,q+s),q="data:image/png;base64,"+q,s="b"+t,b["imgs"+l]=b["imgs"+l]||{},b["imgs"+l][s]=[q,d,m,p,n]);if(e&&l in e)for(r=e[l],t=0,v=r.length;t<v;t++)q=r[t],d=q[0],m=q[1],p=q[2],n=q[3],q=q[4],q=k+q,s="i"+t,b["imgs"+l]=b["imgs"+l]||{},b["imgs"+l][s]=[q,d,m,p,n]}this._checkDirtyTiles();this._placeLt(a)}},_stopLoadingLt:function(a){a=this._lts[a];var b=G.Util.ajaxCancel;a&&(b(a.ri),a.loading=!1)},
_onIconLoad:function(){this._dirtyIcons=!0},_clearGrids:function(){this._g={}},_hitGrids:function(a,b,c,d){for(var f=a;f<=c;f++)for(var e=b;e<=d;e++)if(a=f+","+e,this._g[a])return!0;return!1},_markGrids:function(a,b,c,d){for(var f=a;f<=c;f++)for(var e=b;e<=d;e++)a=f+","+e,this._g[a]=!0}});
G.Layer.Html=G.Layer.Html.extend({_placeHtml:function(a){G.Browser.getPxRatio();var b=G.DomUtil,c=this._map.toScreen(a.geom,this._aroundScreen,this._zoomScale||this._scale),d=c[0],c=c[1];this._hidden?b.hide(a):b.show(a);b.markPosTransform(a,d,c);b.updateTransform(a)},_onZoom:function(){this._zooming&&(this._tempScale==this._latestTempScale?this._erase():this._latestTempScale=this._tempScale)},_onRotate:function(){this._draw()},_onPinch:function(){this._draw()}});
G.Layer.Image=G.Layer.Image.extend({_initContainer:function(){var a=this._map;this.addListener("imageSuccess",a._requestRedraw,a)},_destroyContainer:function(){var a=this._map;this.removeListener("imageSuccess",a._requestRedraw,a)},_update:function(){this._map._isLoaded()&&this._draw()},_draw:function(){var a=this._map,b=this.options,a=this._ctx=a._useOffScreen?a._offScreenCtx:a._onScreenCtx,c,d=1>b.opacity;d&&(a.save(),a.globalAlpha=b.opacity);for(c in this._images)b=this._images[c],b._loaded&&this._placeImage(b);
d&&a.restore()},_placeImage:function(a){if(a._loaded){var b=G.MathUtil,c=G.Browser.getPxRatio(),d=c[0],c=c[1],f=this._map,e=f._res,k=f._rotate,l=a.bbox,m=l[0],p=l[1],n=this._zoomScale||this._scale,q=this._aroundScreen,s=(l[2]-l[0])/e,e=(l[3]-l[1])/e;n&&1!==n&&(s/=n,e/=n);p=f.toScreen([m,p],q,n);m=p[0];p=p[1];f=f._canvasOffset;m+=f[0];p+=f[1];f=this._ctx;k&&(f.save(),f.translate(m,p),f.rotate(k/b.DEGREE_PER_RADIAN),f.translate(-m,-p));try{f.drawImage(a,m,p-e/c,s/d,e/c)}catch(r){}k&&f.restore()}},_onZoomStart:function(){},
_onZoomUpdate:function(){},_onZoomEnd:function(){}});
G.Layer.VectorCache=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{cluster:[]},init:function(a,b){G.Layer.Graphic.prototype.init.call(this,b);this.url=a;this.options=G.Util.merge({},this.options,b);this._vts={};this._visVtKeys=[];this._vIds={}},_initContainer:function(){G.Layer.Graphic.prototype._initContainer.call(this)},_onAdded:function(){this._container||this._initContainer()},_onRemoved:function(){this._container&&this._destroyContainer()},_update:function(){var a=this._map;G.Layer.Graphic.prototype._update.call(this);
a._isLoaded()&&(a=this._calcVisTileInfos(),this._addVts(a))},_addVts:function(a){if(0!==a.length){var b,c,d=[],f,e,k,l;b=0;for(c=a.length;b<c;b++)f=a[b],e=f[0],k=f[1],l=f[2],f=this._getTileName(e,k,l),d.push(f),f in this._vts?(e=this._vts[f],e.data&&this._processVt(f)):this._loadVt(e,k,l);b=0;for(c=this._visVtKeys.length;b<c;b++)f=this._visVtKeys[b],0>d.indexOf(f)&&this._removeVt(f);this._visVtKeys=d}},_removeVt:function(a){this._vts[a]&&this._stopLoadingVt(a)},_loadVt:function(a,b,c){var d=this,
f=d._getTileName(a,b,c),e=d._vts[f]=d._vts[f]||{};e._info=[a,b,c];""!==e.data&&(e.loading=!0,a=d._getTileUrl(a,b,c,{d:"f"}),b={responseType:"http"===a.slice(0,4).toLowerCase()?"JSONP":"JSON",success:function(a,b){e.data=b;d._processVt(f)},error:function(a){404==a.status&&(e.data="")},complete:function(){delete e.req;e.loading=!1}},a=G.Util.ajax(a,b),e.req=a)},_processVt:function(a){for(var b=this._map,c=this._vts[a].data,d=c.v,c=c.s,f,e,k,l,m,p=G.Util.colorHex,n=0,q=d.length;n<q;n++)f=d[n],e=f.id,
k=f.g,l=f.gt,f=f.st,f=c[f],(m=this._vIds[e])?m._updateGeom(k):"pt"===l?m=new G.Graphic.Point(k):"pl"===l?m=new G.Graphic.Polyline(k):"pg"===l&&(m=new G.Graphic.Polygon(k)),m&&(k=m.options,"pt"!==l&&"pl"===l&&(l=f.line_color,k.lineWidth=f.line_width,k.lineColor=p(l[0],l[1],l[2])),m&&(m.addTo(this),m._vtKeys=m._vtKeys||{},m._vtKeys[a]=!0,this._vIds[e]=m));b._requestRedraw()},_stopLoadingVt:function(a){a=this._vts[a];var b=G.Util.ajaxCancel;a&&(b(a.req),a.loading=!1)}});
G.Layer.FeatureService=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{mode:"all",vacuumCount:1E3},init:function(a,b){G.Layer.Graphic.prototype.init.call(this,b);this.options=G.Util.merge({},this.options,b);this._reqFunc=a;this._loadingKeys={}},onSuccess:function(a){"tile"==this.options.mode?this.fireEvent("loadTileSuccess",{extent:a}):this.fireEvent("loadAllSuccess")},onError:function(a){"tile"==this.options.mode?this.fireEvent("loadTileError",{extent:a}):this.fireEvent("loadAllError")},onComplete:function(a){if("tile"==
this.options.mode){var b=a.join(",");delete this._loadingKeys[b];this.fireEvent("loadTileComplete",{extent:a})}else this.fireEvent("loadAllComplete")},_update:function(){var a=this._map;G.Layer.Graphic.prototype._update.call(this);a._isLoaded()&&("tile"==this.options.mode?(this.count()>this.options.vacuumCount&&this._vacuum(),a=this._calcVisTileInfos(),this._addFts(a)):this._loadAll())},_addFts:function(a){if(0!==a.length){var b,c,d,f,e,k=this._loadingKeys,l={};b=0;for(c=a.length;b<c;b++)f=a[b],d=
f[0],e=f[1],f=f[2],e=this._calcTileExtent(d,e,f),d=e.join(","),l[d]=e;for(d in k)l[d]||(a=k[d],G.Util.ajaxCancel(a),delete k[d]);for(d in l)e=l[d],this._loadFt(e)}},_loadFt:function(a){var b=a.join(","),c=this._reqFunc;b in this._loadingKeys||!c||(c=c.call(this,a),this._loadingKeys[b]=c,this.fireEvent("loadTileStart",{extent:a}))},_loadAll:function(){var a=this._reqFunc;"all"in this._loadingKeys||!a||(a=a.call(this),this._loadingKeys.all=a,this.fireEvent("loadAllStart"))}});
G.Layer.GeoHeyFeature=G.Layer.FeatureService.extend({options:{apiKey:"",where:"1=1",outFields:"",limit:1E3},init:function(a,b){var c=this;G.Layer.FeatureService.prototype.init.call(c,function(b){var f=a+"/query",e=c.options,k={ak:e.apiKey,where:e.where,outFields:e.outFields,limit:e.limit};b&&(k.geometry=JSON.stringify(b));k={responseType:"http"===f.slice(0,4).toLowerCase()?"JSONP":"JSON",data:k,success:function(a,f){var k=f.data,n=k.geometryType;if(k=k.features){var q;q=k.length-1;for(var s=Math.max(0,
q-e.limit),r,t,v,u=[],x,y,z;q>=s;q--){r=k[q];t=r.id;v=r.geom;r=r.attrs||{};if("Point"==n)u.push(new G.Graphic.Point(v,r));else if("Polyline"==n)u.push(new G.Graphic.Polyline(v,r));else if("Polygon"==n)u.push(new G.Graphic.Polygon(v,r));else if("MultiPoint"==n)for(x in v.m)y=v.m[x],u.push(new G.Graphic.Point(y,r));else if("MultiPolyline"==n)for(x in v.m)y=v.m[x],u.push(new G.Graphic.Polyline(y,r));else if("MultiPolygon"==n)for(x in v.m)y=v.m[x],u.push(new G.Graphic.Polygon(y,r));for(z in u)if(r=u[z])v=
t+"_"+z,c.get(v)||r.addTo(c,v)}}c.onSuccess(b)},error:function(){c.onError(b)},complete:function(){c.onComplete(b)}};G.Util.ajax(f,k)},b)}});
G.Layer.GeoHeyProgressiveFeature=G.Layer.Graphic.extend({options:{stepFactor:4,stepCount:4,tolerance:8,outFields:"[]"},init:function(a,b){G.Layer.Graphic.prototype.init.call(this,b);this.url=a},onSuccess:function(a){this.fireEvent("extentSuccess",{extent:a})},onError:function(a){this.fireEvent("extentError",{extent:a})},onComplete:function(a){this.fireEvent("extentComplete",{extent:a})},_update:function(){var a=this._map,b=this._loadRes=a._res,c=this._loadExtent=a.getExtent(),d=this._loadedStatus;
if(!d||b!=d[0]||!G.ExtentUtil.equals(c,d[1]))if(G.Layer.Graphic.prototype._update.call(this),a._isLoaded()){(a=this._req)&&G.Util.ajaxCancel(a);var f,b=this._graphics;for(f in b)a=b[f],a._dirty=!0;this._loadStep(1)}},_loadStep:function(a){var b=this,c=b.options,d=b._loadRes,f=b._loadExtent,e=c.tolerance*Math.pow(c.stepFactor,c.stepCount-a),k=b.url+"/filter",c={responseType:"JSON",data:{extent:JSON.stringify(f),excludeExtents:JSON.stringify([]),res:d,cellPixel:e,outFields:c.outFields},success:function(c,
d){b._processResult(a,d)},complete:function(){b._req=null}};b._req=G.Util.ajax(k,c)},_processResult:function(a,b){var c=this.options,d=this._loadRes,f=this._loadExtent,e=c.tolerance*Math.pow(c.stepFactor,c.stepCount-a),e=d*e,k=b.geometryType,l=b.features;if(l){var m,p,n,q,s,r;for(m=l.length-1;0<=m;m--)if(p=l[m],n=p.id,q=p.geom,p=p.attrs||{},"Point"==k)r=new G.Graphic.Point(q,p),this._updateGraphic(e,n,0,r);else if("Polyline"==k)r=new G.Graphic.Polyline(q,p),this._updateGraphic(e,n,0,r);else if("Polygon"==
k)r=new G.Graphic.Polygon(q,p),this._updateGraphic(e,n,0,r);else if("MultiPoint"==k)for(s in q.multi)r=q.multi[s],r=new G.Graphic.Point(r,p),this._updateGraphic(e,n,s,r);else if("MultiPolyline"==k)for(s in q.multi)r=q.multi[s],r=new G.Graphic.Polyline(r,p),this._updateGraphic(e,n,s,r);else if("MultiPolygon"==k)for(s in q.multi)r=q.multi[s],r=new G.Graphic.Polygon(r,p),this._updateGraphic(e,n,s,r);a<c.stepCount?this._loadStep(a+1):(this._clearDirty(),this._loadedStatus=[d,f],this.onSuccess(f),this.onComplete(f))}else this.onError(f),
this.onComplete(f)},_updateGraphic:function(a,b,c,d){b+=c?"_"+c:"";(c=this.get(b))?(a<c._res&&(c.updateGeom(d.geom,!0),c._res=a),c._dirty=!1):(d._res=a,d.addTo(this,b))},_clearDirty:function(){var a=this._graphics,b,c;for(c in a)b=a[c],b._dirty&&b.remove()}});
G.Layer.TiledService=G.Layer.extend({mixins:[G.Layer.LOD],init:function(a,b){this.options=G.Util.merge({},this.options,b);this._reqFunc=a;this._loadingKeys={};this._loadedKeys={}},onSuccess:function(a,b){var c=parseInt(a[0]),d=parseInt(a[1]),f=parseInt(a[2]),c=this._getTileName(c,d,f);this._loadedKeys[c]=a;this.fireEvent("loadTileSuccess",{tileInfo:a,data:b})},onError:function(a){this.fireEvent("loadTileError",{tileInfo:a})},onComplete:function(a){var b=parseInt(a[0]),c=parseInt(a[1]),d=parseInt(a[2]),
b=this._getTileName(b,c,d);delete this._loadingKeys[b];this.fireEvent("loadTileComplete",{tileInfo:a})},_update:function(){if(this._map._isLoaded()){var a,b,c,d,f,e,k=this._calcVisTileInfos(),l={};a=0;for(b=k.length;a<b;a++)d=k[a],c=d[0],f=d[1],e=d[2],c=this._getTileName(c,f,e),l[c]=d;this._addTiles(l);for(c in this._loadedKeys)l[c]||(d=this._loadedKeys[c],delete this._loadedKeys[c],this.fireEvent("unusedTile",{tileInfo:d}))}},_addTiles:function(a){var b,c,d=this._loadingKeys;for(b in d)a[b]||(c=
d[b],G.Util.ajaxCancel(c),delete d[b]);for(b in a)c=a[b],this._loadTile(c)},_loadTile:function(a){var b=this._reqFunc,c=parseInt(a[0]),d=parseInt(a[1]),f=parseInt(a[2]),e=this._getTileName(c,d,f);e in this._loadingKeys||e in this._loadedKeys||!b||(b=b.call(this,c,d,f),this._loadingKeys[e]=b,this.fireEvent("loadTileStart",{tileInfo:a}))}});
G.Graphic.Point=G.Graphic.Point.extend({_onAdded:function(){var a=this._layer._map;a&&a._requestRedraw()},_onRemoved:function(){var a=this._layer._map;a&&a._requestRedraw()},_draw:function(){var a=this.options,b=this._layer,c=b._map,b=b._ctx,d=Math.round,f=a.shape,e=a.size,k=e[0],e=e[1],l=a.offset,m=a.imageRotate;a.imageGravity||(m+=c._rotate);"image"==f&&m&&(l=G.MathUtil.rotateVector(l,m));for(var p=this.geom[0],n=this.geom[1],q=c._canvasOffset,s=c._calcWrapPointRange(this.geom)||[0,0],r=c.options.maxExtent,
r=r[2]-r[0],t=s[0];t<=s[1];t++){var v=c.toScreen([p+t*r,n]),u=v[0]+l[0],v=v[1]+l[1],u=u+q[0],v=v+q[1];if("rect"==f)b.beginPath(),b.rect(u-k/2,v-e/2,k,e),this._renderPath(u,v,Math.max(k/2,e/2));else if("image"==f){var x=G.Browser.getImageSrc(a.image),x=G.DomUtil.getImgElement(x,function(){c._requestRedraw()});x._loaded&&(b.save(),b.translate(d(u),d(v)),b.rotate(m/G.MathUtil.DEGREE_PER_RADIAN),b.drawImage(x,0,0,k,e),b.restore())}else"text"==f?(b.save(),b.fillStyle=a.fillColor,b.globalAlpha=a.fillOpacity,
b.font=a.textStyle+" "+k+"px "+a.textFont,b.textAlign=a.textAlign,b.textBaseline="middle",x=a.text,this._textMeasureWidth&&this._textMeasure==x||(this._textMeasureWidth=b.measureText(x).width,this._textMeasure=x),b.fillText(x,u,v),b.restore()):(b.beginPath(),b.arc(u,v,k/2,0,2*Math.PI),this._renderPath(u,v,k/2))}},_renderPath:function(a,b,c){var d=this._layer,f=d._map,d=d._ctx,e=this.options;d.save();e.fill&&(e.fillImage?(a=G.Browser.getimgSrc(e.fillImage),a=G.DomUtil.getImgElement(a,function(){f._requestRedraw()}),
a._loaded?(d.fillStyle=d.createPattern(a,"repeat"),d.globalAlpha=e.fillOpacity):d.globalAlpha=0):e.gradual?(a=d.createRadialGradient(a,b,0,a,b,c),b=G.Util.colorRgb(e.fillColor),a.addColorStop(0,e.fillColor),a.addColorStop(1,"rgba("+b[0]+","+b[1]+","+b[2]+","+e.fillOpacity+")"),d.fillStyle=a):(d.fillStyle=e.fillColor,d.globalAlpha=e.fillOpacity),d.fill());if(e.outline||this._mouseOver||this._editing)d.strokeStyle=this._editing?e.lineHighlightColor:e.outline?e.outlineColor:e.fillColor,d.lineWidth=this._mouseOver?
e.outlineWidth+e.lineHighlightWiden:e.outlineWidth,d.globalAlpha=e.outlineOpacity,G.Util.setCanvasLineDash(d,e.outlineDashArray),d.stroke();d.restore()},_onStartEdit:function(){var a=this._layer._map,b=this.virtualMouse,c;for(c in b.DOWN)a.addListener(b.DOWN[c],this._onVertexDragStart,this);this._refreshVertexes()},_onEndEdit:function(){var a=this._layer._map,b=this.virtualMouse,c;for(c in b.DOWN)a.removeListener(b.DOWN[c],this._onVertexDragStart,this);this._removeVertexes()},_onMouseOver:function(){var a=
this._layer;if(a){var a=a._map,b=G.DomUtil,c=a._handlers.Drag;!c||(c._dragging||this.options.allowPan)||c.off();a._requestRedraw();this._isVertex?b.addClass(a._layersFrame,"g-edit"):b.addClass(a._layersFrame,"g-clickable")}},_onMouseOut:function(){var a=this._layer;if(a){var a=a._map,b=G.DomUtil,c=a._handlers.Drag;if(c&&!c._dragging)c.on();a._requestRedraw();this._isVertex?b.removeClass(a._layersFrame,"g-edit"):b.removeClass(a._layersFrame,"g-clickable")}}});
G.Graphic.Polyline=G.Graphic.Polyline.extend({_onAdded:function(){var a=this._layer._map;a&&a._requestRedraw()},_onRemoved:function(){var a=this._layer._map;a&&a._requestRedraw()},_draw:function(){var a=this.options,b=this._layer,c=b._map,b=b._ctx,d=this.geom,f,e,k=c._canvasOffset,l=this.bbox,l=c._calcWrapPointRange([(l[0]+l[2])/2,(l[1]+l[3])/2])||[0,0];f=c.options.maxExtent;var m=f[2]-f[0];b.save();for(var p=l[0];p<=l[1];p++){b.beginPath();for(var n=0;n<d.length;n++)e=d[n],e=c.toScreen([e[0]+p*m,
e[1]]),f=0===n?"moveTo":"lineTo",b[f](e[0]+k[0],e[1]+k[1]);b.strokeStyle=this._editing?a.lineHighlightColor:a.lineColor;b.lineCap=a.lineCap;b.lineJoin=a.lineJoin;b.lineWidth=this._mouseOver?a.lineWidth+a.lineHighlightWiden:a.lineWidth;b.globalAlpha=a.lineOpacity;G.Util.setCanvasLineDash(b,a.lineDashArray);b.stroke()}b.restore()},_onStartEdit:function(){var a=this._layer._map,b=this.virtualMouse;for(i in b.DOWN)a.addListener(b.DOWN[i],this._onVertexDragStart,this);this._refreshVertexes()},_onEndEdit:function(){var a=
this._layer._map,b=this.virtualMouse,c,d;for(c in b.DOWN)d=b.DOWN[c],a.removeListener(d,this._onVertexDragStart,this),a.removeListener(b.MOVE[d],this._onVertexDrag,this),a.removeListener(b.UP[d],this._onVertexDragEnd,this);this._removeVertexes();G.DomUtil.removeClass(a._layersFrame,"g-edit");a._requestRedraw()},_onMouseOver:function(){var a=this._layer._map,b=a._handlers.Drag;!b||(b._dragging||this.options.allowPan)||b.off();a._requestRedraw();G.DomUtil.addClass(a._layersFrame,"g-clickable")},_onMouseOut:function(){var a=
this._layer._map,b=a._handlers.Drag;if(b&&!b._dragging)b.on();a._requestRedraw();G.DomUtil.removeClass(a._layersFrame,"g-clickable")}});
G.Graphic.Polygon=G.Graphic.Polygon.extend({_onAdded:function(){var a=this._layer._map;a&&a._requestRedraw()},_onRemoved:function(){var a=this._layer._map;a&&a._requestRedraw()},_draw:function(){var a=this.options,b=this._layer,c=b._map,b=b._ctx,d=this.geom,f,e,k,l=c._canvasOffset,m=this.bbox,m=c._calcWrapPointRange([(m[0]+m[2])/2,(m[1]+m[3])/2])||[0,0],p=c.options.maxExtent,p=p[2]-p[0];b.save();for(var n=m[0];n<=m[1];n++){b.beginPath();for(var q=0,s=d.length;q<s;q++){e=d[q];for(var r=0,t=e.length;r<
t;r++)k=e[r],k=c.toScreen([k[0]+n*p,k[1]]),f=0===r?"moveTo":"lineTo",b[f](k[0]+l[0],k[1]+l[1]);k=e[0];k=c.toScreen([k[0]+n*p,k[1]]);b.lineTo(k[0]+l[0],k[1]+l[1])}a.fill&&(a.fillImage?(f=G.Browser.getImageSrc(a.fillImage),f=G.DomUtil.getImgElement(f,function(){c._requestRedraw()},null,"*"),f._loaded?(b.fillStyle=b.createPattern(f,"repeat"),b.globalAlpha=a.fillOpacity):b.globalAlpha=0):(b.fillStyle=a.fillColor,b.globalAlpha=a.fillOpacity),b.fill());if(a.outline||this._mouseOver||this._editing)b.strokeStyle=
this._editing?a.lineHighlightColor:a.outline?a.outlineColor:a.fillColor,b.lineCap=a.outlineCap,b.lineJoin=a.outlineJoin,b.lineWidth=(a.outline?a.outlineWidth:0)+(this._mouseOver?a.lineHighlightWiden:0),b.globalAlpha=a.outlineOpacity,G.Util.setCanvasLineDash(b,a.outlineDashArray),b.stroke()}b.restore()},_drawMask:function(){var a=this._map,b=a._maskCtx,c=this.geom,d,f,e,k=a._canvasOffset,l=this.bbox,l=a._calcWrapPointRange([(l[0]+l[2])/2,(l[1]+l[3])/2])||[0,0];d=a.options.maxExtent;var m=d[2]-d[0];
b.beginPath();for(var p=l[0];p<=l[1];p++)for(var n=0,q=c.length;n<q;n++){f=c[n];for(var s=0,r=f.length;s<r;s++)e=f[s],e=a.toScreen([e[0]+p*m,e[1]]),d=0===s?"moveTo":"lineTo",b[d](e[0]+k[0],e[1]+k[1]);e=f[0];e=a.toScreen([e[0]+p*m,e[1]]);b.lineTo(e[0]+k[0],e[1]+k[1])}b.fill()},_onStartEdit:function(){var a=this._layer._map,b=this.virtualMouse;for(i in b.DOWN)a.addListener(b.DOWN[i],this._onVertexDragStart,this);this._refreshVertexes()},_onEndEdit:function(){var a=this._layer._map,b=this.virtualMouse,
c,d;for(c in b.DOWN)d=b.DOWN[c],a.removeListener(d,this._onVertexDragStart,this),a.removeListener(b.MOVE[d],this._onVertexDrag,this),a.removeListener(b.UP[d],this._onVertexDragEnd,this);this._removeVertexes();G.DomUtil.removeClass(a._layersFrame,"g-edit");a._requestRedraw()},_onMouseOver:function(){var a=this._layer._map,b=a._handlers.Drag;!b||(b._dragging||this.options.allowPan)||b.off();a._requestRedraw();G.DomUtil.addClass(a._layersFrame,"g-clickable")},_onMouseOut:function(){var a=this._layer._map,
b=a._handlers.Drag;if(b&&!b._dragging)b.on();a._requestRedraw();G.DomUtil.removeClass(a._layersFrame,"g-clickable")}});
G.Graphic.Circle=G.Graphic.Circle.extend({_onAdded:function(){var a=this._layer._map;a&&a._requestRedraw()},_onRemoved:function(){var a=this._layer._map;a&&a._requestRedraw()},_draw:function(){var a=this.options,b=this._layer,c=b._map,b=b._ctx,d=this.geom,f=d[0],e=d[1],k=d[2]/c._res,l=c._canvasOffset,d=c._calcWrapPointRange(d)||[0,0],m=c.options.maxExtent,m=m[2]-m[0];b.save();for(var p=d[0];p<=d[1];p++){var n=c.toScreen([f+p*m,e]);n[0]+=l[0];n[1]+=l[1];b.beginPath();b.arc(n[0],n[1],k,0,2*Math.PI);
if(a.fill){if(a.fillImage)n=G.Browser.getImageSrc(a.fillImage),n=G.DomUtil.getImgElement(n,function(){c._requestRedraw()},null,"*"),n._loaded?(b.fillStyle=b.createPattern(n,"repeat"),b.globalAlpha=a.fillOpacity):b.globalAlpha=0;else if(a.gradual){var n=b.createRadialGradient(n[0],n[1],0,n[0],n[1],k),q=G.Util.colorRgb(a.fillColor);n.addColorStop(0,a.fillColor);n.addColorStop(1,"rgba("+q[0]+","+q[1]+","+q[2]+","+a.fillOpacity+")");b.fillStyle=n}else b.fillStyle=a.fillColor,b.globalAlpha=a.fillOpacity;
b.fill()}if(a.outline||this._mouseOver)b.strokeStyle=this._editing?a.lineHighlightColor:a.outlineColor,b.lineWidth=this._mouseOver?a.outlineWidth+a.lineHighlightWiden:a.outlineWidth,b.globalAlpha=a.outlineOpacity,G.Util.setCanvasLineDash(b,a.outlineDashArray),b.stroke()}b.restore()},_drawMask:function(){var a=this._map,b=a._maskCtx,c=this.geom,d=c[0],f=c[1],e=c[2]/a._res,k=a._canvasOffset,c=a._calcWrapPointRange(c)||[0,0],l=a.options.maxExtent,l=l[2]-l[0];b.beginPath();for(var m=c[0];m<=c[1];m++){var p=
a.toScreen([d+m*l,f]);p[0]+=k[0];p[1]+=k[1];b.arc(p[0],p[1],e,0,2*Math.PI,!1)}b.fill()},_onStartEdit:function(){var a=this._layer._map,b=this.virtualMouse,c;for(c in b.DOWN)a.addListener(b.DOWN[c],this._onVertexDragStart,this);this._refreshVertexes()},_onEndEdit:function(){var a=this._layer._map,b=this.virtualMouse,c;for(c in b.DOWN)a.removeListener(b.DOWN[c],this._onVertexDragStart,this);this._removeVertexes()},_onMouseOver:function(){var a=this._layer._map,b=a._handlers.Drag;!b||(b._dragging||this.options.allowPan)||
b.off();a._requestRedraw();G.DomUtil.addClass(a._layersFrame,"g-clickable")},_onMouseOut:function(){var a=this._layer._map,b=a._handlers.Drag;if(b&&!b._dragging)b.on();a._requestRedraw();G.DomUtil.removeClass(a._layersFrame,"g-clickable")}});
G.Graphic.Arrow=G.Graphic.Arrow.extend({_draw:function(){var a=this.options,b=this._layer,c=b._map,b=b._ctx;this._updateGeomDraw(c._res);var d=this._geomDraw,f,e,k,l=c._canvasOffset,m=this.bbox,m=c._calcWrapPointRange([(m[0]+m[2])/2,(m[1]+m[3])/2])||[0,0],p=c.options.maxExtent,p=p[2]-p[0];b.save();for(var n=m[0];n<=m[1];n++){b.beginPath();for(var q=0,s=d.length;q<s;q++){e=d[q];for(var r=0,t=e.length;r<t;r++)k=e[r],k=c.toScreen([k[0]+n*p,k[1]]),f=0===r?"moveTo":"lineTo",b[f](k[0]+l[0],k[1]+l[1]);k=
e[0];k=c.toScreen([k[0]+n*p,k[1]]);b.lineTo(k[0]+l[0],k[1]+l[1])}a.fill&&(a.fillImage?(f=G.Browser.getImageSrc(a.fillImage),f=G.DomUtil.getImgElement(f,function(){c._requestRedraw()},null,"*"),f._loaded?(b.fillStyle=b.createPattern(f,"repeat"),b.globalAlpha=a.fillOpacity):b.globalAlpha=0):(b.fillStyle=a.fillColor,b.globalAlpha=a.fillOpacity),b.fill());if(a.outline||this._mouseOver||this._editing)b.strokeStyle=this._editing?a.lineHighlightColor:a.outline?a.outlineColor:a.fillColor,b.lineCap=a.outlineCap,
b.lineJoin=a.outlineJoin,b.lineWidth=(a.outline?a.outlineWidth:0)+(this._mouseOver?a.lineHighlightWiden:0),b.globalAlpha=a.outlineOpacity,G.Util.setCanvasLineDash(b,a.outlineDashArray),b.stroke()}b.restore()},_drawMask:function(){var a=this._map,b=a._maskCtx;this._updateGeomDraw(a._res);var c=this._geomDraw,d,f,e,k=a._canvasOffset,l=this.bbox,l=a._calcWrapPointRange([(l[0]+l[2])/2,(l[1]+l[3])/2])||[0,0];d=a.options.maxExtent;var m=d[2]-d[0];b.beginPath();for(var p=l[0];p<=l[1];p++)for(var n=0,q=c.length;n<
q;n++){f=c[n];for(var s=0,r=f.length;s<r;s++)e=f[s],e=a.toScreen([e[0]+p*m,e[1]]),d=0===s?"moveTo":"lineTo",b[d](e[0]+k[0],e[1]+k[1]);e=f[0];e=a.toScreen([e[0]+p*m,e[1]]);b.lineTo(e[0]+k[0],e[1]+k[1])}b.fill()},_onStartEdit:function(){var a=this._layer._map,b=this.virtualMouse;for(i in b.DOWN)a.addListener(b.DOWN[i],this._onVertexDragStart,this);this._refreshVertexes()},_onEndEdit:function(){var a=this._layer._map,b=this.virtualMouse,c,d;for(c in b.DOWN)d=b.DOWN[c],a.removeListener(d,this._onVertexDragStart,
this),a.removeListener(b.MOVE[d],this._onVertexDrag,this),a.removeListener(b.UP[d],this._onVertexDragEnd,this);this._removeVertexes();G.DomUtil.removeClass(a._layersFrame,"g-edit");a._requestRedraw()},_onMouseOver:function(){var a=this._layer._map,b=a._handlers.Drag;!b||(b._dragging||this.options.allowPan)||b.off();a._requestRedraw();G.DomUtil.addClass(a._layersFrame,"g-clickable")},_onMouseOut:function(){var a=this._layer._map,b=a._handlers.Drag;if(b&&!b._dragging)b.on();a._requestRedraw();G.DomUtil.removeClass(a._layersFrame,
"g-clickable")}});G.Graphic.Group=G.Graphic.Group.extend({_onMouseOver:function(){var a=this._layer._map,b=a._handlers.Drag;!b||(b._dragging||this.options.allowPan)||b.off();a._requestRedraw();G.DomUtil.addClass(a._layersFrame,"g-clickable")},_onMouseOut:function(){var a=this._layer._map,b=a._handlers.Drag;if(b&&!b._dragging)b.on();a._requestRedraw();G.DomUtil.removeClass(a._layersFrame,"g-clickable")}});
G.Map=G.Map.extend({print:function(a,b){var c=G.DomUtil,d=G.Browser.getCanvasRatio(),f=this.getSize(),e=f[0],k=f[1],f=a||e,l=b||k,e=Math.max(f/e,l/k),k=this._onScreenCtx.canvas,m=k.width/d[0],d=k.height/d[1],c=c.create("canvas");c.width=f;c.height=l;c.getContext("2d").drawImage(k,(f-m*e)/2,(l-d*e)/2,m*e,d*e);return c.toDataURL()},_initAddition:function(){var a=G.DomUtil,b=this._useOffScreen=!window.G_OFF_CANVAS_OFFSCREEN;this._onScreenCtx=a.create("canvas","g-layer",this._layersFrame).getContext("2d");
b&&(this._offScreenCtx=a.create("canvas").getContext("2d"));this._snapshotCtx=a.create("canvas").getContext("2d");this._maskCtx=a.create("canvas").getContext("2d");this._mode="canvas"},_redrawSnapshot:function(a,b,c){var d=G.Browser.getCanvasRatio(),f=this._onScreenCtx.canvas,e=f.width/(d[0]||1),d=f.height/(d[1]||1),f=G.Browser.getPxRatio(),k=f[0],l=f[1],m=this._center,p=this._rotate,n=this._res,f=p-b,q=n/c,s=this._onScreenCtx,r,t;r=-e/2;t=-d/2;b&&(b=G.MathUtil.rotateVector([r,t],-b),r=b[0],t=b[1]);
b=r*c*k+a[0];a=-t*c*l+a[1];r=(b-m[0])/n/k;t=-(a-m[1])/n/l;p&&(b=G.MathUtil.rotateVector([r,t],p),r=b[0],t=b[1]);a=e/2+r;c=d/2+t;this._clearCanvas(s);s.save();s.translate(a,c);s.rotate(f/G.MathUtil.DEGREE_PER_RADIAN);s.drawImage(this._snapshotCtx.canvas,0,0,e/q,d/q);s.restore()},_redraw:function(){var a=this._useOffScreen,b=this._onScreenCtx.canvas,c=this._zoomAnim,d=this._rotateAnim,f=this._handlers.Pinch;if(!this.options.canvasAnimRedraw&&c&&c._playing)this._redrawSnapshot(c._startCenter,this._rotate,
c._startRes);else if(!this.options.canvasAnimRedraw&&d&&d._playing)this._redrawSnapshot(this._center,d._startRotate,this._res);else if(!this.options.canvasAnimRedraw&&f&&f._pinching)this._redrawSnapshot(f._startCenter,f._startRotate,f._startRes);else{a?this._clearCanvas(this._offScreenCtx):this._clearCanvas(this._onScreenCtx);for(var e in this._layerOrder)c=this._layerOrder[e],(c=this._layers[c])&&c.isVisible()&&c._draw();this._drawMask();if(a){ratio=G.Browser.getCanvasRatio();w=b.width/(ratio[0]||
1);h=b.height/(ratio[1]||1);try{this._clearCanvas(this._onScreenCtx),this._onScreenCtx.drawImage(this._offScreenCtx.canvas,0,0,w,h)}catch(k){}}try{this._onScreenCtx.drawImage(this._maskCtx.canvas,0,0)}catch(l){}}},_update:function(){var a=this._useOffScreen,b=this._onScreenCtx.canvas,c;a?this._clearCanvas(this._offScreenCtx):this._clearCanvas(this._onScreenCtx);var d;for(c in this._layerOrder)d=this._layerOrder[c],(d=this._layers[d])&&d.isVisible()&&d._update();this._drawMask();if(a){c=G.Browser.getCanvasRatio();
a=b.width/(c[0]||1);b=b.height/(c[1]||1);try{this._clearCanvas(this._onScreenCtx),this._onScreenCtx.drawImage(this._offScreenCtx.canvas,0,0,a,b)}catch(f){}}try{this._onScreenCtx.drawImage(this._maskCtx.canvas,0,0)}catch(e){}},_drawMask:function(){var a=this._maskCtx,b=this.options,c,d=this._masks;if(d){var f=d.length;if(b.mask&&(this._clearCanvas(this._maskCtx),0!=f)){a.save();a.globalCompositeOperation="source-over";a.fillStyle=b.maskColor;a.globalAlpha=b.maskOpacity;a.fillRect(0,0,a.canvas.width,
a.canvas.height);a.globalCompositeOperation="destination-out";a.globalAlpha=1;for(b=0;b<f;b++)c=d[b],c._drawMask&&c._drawMask();a.restore()}}},_onResize:function(){this._resizeCanvases();this._updateDrawSize();this._requestUpdate()},_clearCanvas:function(a){a.clearRect(0,0,a.canvas.width,a.canvas.height)},_resizeCanvas:function(a,b,c,d){if(a&&b&&c){var f=a.canvas,e=d?d[0]||1:1;d=d?d[1]||1:1;var k=this.options.canvasExpandFactor,l=b*k,k=c*k;b+=2*l;c+=2*k;G.DomUtil.setPosition(f,-l,-k);1==e&&1==d?(f.width=
b,f.height=c,f.style.width="",f.style.height="",a.scale(1,1)):(f.width=b*e,f.height=c*d,f.style.width=b+"px",f.style.height=c+"px",a.scale(e,d))}},_resizeCanvases:function(){var a=this.getSize(),b=a[0],a=a[1],c=G.Browser.getCanvasRatio(),d=this.options.canvasExpandFactor;this._canvasOffset=[b*d,a*d];this._resizeCanvas(this._onScreenCtx,b,a,c);this._resizeCanvas(this._snapshotCtx,b,a,c);this._resizeCanvas(this._maskCtx,b,a,[1,1]);this._useOffScreen&&this._resizeCanvas(this._offScreenCtx,b,a,c)},_onZoomStart:function(a){this._snapshotCanvas()},
_onRotateStart:function(a){this._snapshotCanvas()},_onPinchStart:function(a){this._snapshotCanvas()},_snapshotCanvas:function(){if(!this.options.canvasAnimRedraw){var a=this._onScreenCtx.canvas,b=G.Browser.getCanvasRatio(),c=a.width/(b[0]||1),b=a.height/(b[1]||1);this._clearCanvas(this._snapshotCtx);this._snapshotCtx.drawImage(a,0,0,c,b)}},_calcCanvasOffset:function(){var a=this.getSize(),b=this.getDrawSize();return[(a[0]-b[0])/2,(a[1]-b[1])/2]},_beforeMergeFramePos:function(){var a=G.DomUtil.getPosition(this._mapFrame),
b=a[0],a=a[1];try{this._onScreenCtx.drawImage(this._onScreenCtx.canvas,b,a)}catch(c){}}});
